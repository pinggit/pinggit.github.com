<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>mylogin.tcl.html</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta name="syntax" content="tcl" />
<style type="text/css">
<!--
.WarningMsg { color: #ff6060; }
.Comment { color: #00ffff; font-weight: bold; }
.Statement { color: #ffff00; font-weight: bold; }
.Identifier { color: #ffff00; }
.Constant { color: #ff40ff; font-weight: bold; }
.Special { color: #ff6060; font-weight: bold; }
pre { font-family: monospace; color: #ffffff; background-color: #000000; }
body { font-family: monospace; color: #ffffff; background-color: #000000; }
.lnr { color: #00ffff; }
.FoldColumn { color: #00ffff; background-color: #808080; font-weight: bold; }
.FoldColumn { text-decoration: none; white-space: pre; }
.open-fold   .Folded      { display: none; }
.open-fold   .fulltext      { display: inline; }
.open-fold   .toggle-open   { display: none; }
.closed-fold .toggle-closed { display: inline; }

.closed-fold .fulltext      { display: none; }
.closed-fold .Folded      { display: inline; }
.closed-fold .toggle-open   { display: inline; }
.closed-fold .toggle-closed { display: none; }
-->
</style>

<script type='text/javascript'>
<!--
function toggleFold(objID)
{
  var fold;
  fold = document.getElementById(objID);
  if(fold.className == 'closed-fold')
  {
    fold.className = 'open-fold';
  }
  else if (fold.className == 'open-fold')
  {
    fold.className = 'closed-fold';
  }
}
-->
</script>
</head>
<body>
<pre>
<span class="FoldColumn">  </span><span class="lnr">   1 </span><span class="Comment">#!/usr/bin/env expect</span>
<span class="FoldColumn">  </span><span class="lnr">   2 </span><span class="Comment">#this may it a bit more portable</span>
<span class="FoldColumn">  </span><span class="lnr">   3 </span><span class="Comment">#</span>
<span class="FoldColumn">  </span><span class="lnr">   4 </span><span class="Comment">#a script to (partially) simulate secureCRT funtions </span>
<span class="FoldColumn">  </span><span class="lnr">   5 </span><span class="Comment">#</span>
<span class="FoldColumn">  </span><span class="lnr">   6 </span><span class="Comment">#main features available currently:                                   #</span>
<span class="FoldColumn">  </span><span class="lnr">   7 </span><span class="Comment">#    anti-idle                                                           #</span>
<span class="FoldColumn">  </span><span class="lnr">   8 </span><span class="Comment">#    auto-login (with retry)                                         #</span>
<span class="FoldColumn">  </span><span class="lnr">   9 </span><span class="Comment">#    name-to-host resolving                                           #</span>
<span class="FoldColumn">  </span><span class="lnr">  10 </span><span class="Comment">#    quick keystroke cmds under interact mode(after a successful login)         #</span>
<span class="FoldColumn">  </span><span class="lnr">  11 </span><span class="Comment">#    loggings                                                     #</span>
<span class="FoldColumn">  </span><span class="lnr">  12 </span><span class="Comment">#       change log file in real time,                                #</span>
<span class="FoldColumn">  </span><span class="lnr">  13 </span><span class="Comment">#       email current log file to user (or update case),as attachement          #</span>
<span class="FoldColumn">  </span><span class="lnr">  14 </span><span class="Comment">#       attachment can be either plain text or optionally in zip format         #</span>
<span class="FoldColumn">  </span><span class="lnr">  15 </span><span class="Comment">#    execution of user-defined cmds,in desired sequence                       #</span>
<span class="FoldColumn">  </span><span class="lnr">  16 </span><span class="Comment">#       cmds can be grouped                                           #</span>
<span class="FoldColumn">  </span><span class="lnr">  17 </span><span class="Comment">#       cmds can be executed repeatedly in user-defined number of loops         #</span>
<span class="FoldColumn">  </span><span class="lnr">  18 </span><span class="Comment">#       cmd lists can be modified/updated w/o disconnecting current session     #</span>
<span class="FoldColumn">  </span><span class="lnr">  19 </span><span class="Comment">#       clock(timestamp of the cmd execution) can be prefixed for each cmd      #</span>
<span class="FoldColumn">  </span><span class="lnr">  20 </span><span class="Comment">#       send logs as email attachment, right away, or at a later time    #</span>
<span class="FoldColumn">  </span><span class="lnr">  21 </span><span class="Comment">#    execution of user-defined pattern-action list                        #</span>
<span class="FoldColumn">  </span><span class="lnr">  22 </span><span class="Comment">#       dealing with changing/arbitrary prompts                              #</span>
<span class="FoldColumn">  </span><span class="lnr">  23 </span><span class="Comment">#       one example work done by this feature is the coredump analysis          #</span>
<span class="FoldColumn">  </span><span class="lnr">  24 </span><span class="Comment">#       (file search,upload,telnet,decompress,decode,reformat,                 #</span>
<span class="FoldColumn">  </span><span class="lnr">  25 </span><span class="Comment">#       email to user/case, etc)                                           #</span>
<span class="FoldColumn">  </span><span class="lnr">  26 </span><span class="Comment">#    misc.                                                           #</span>
<span class="FoldColumn">  </span><span class="lnr">  27 </span><span class="Comment">#       ...                                                         #</span>
<span class="FoldColumn">  </span><span class="lnr">  28 </span><span class="Comment">#       </span>
<span class="FoldColumn">  </span><span class="lnr">  29 </span><span class="Comment">#</span>
<span class="FoldColumn">  </span><span class="lnr">  30 </span><span class="Comment">#work done:</span>
<span class="FoldColumn">  </span><span class="lnr">  31 </span><span class="Comment">#    some basic features are done </span>
<span class="FoldColumn">  </span><span class="lnr">  32 </span><span class="Comment">#</span>
<span class="FoldColumn">  </span><span class="lnr">  33 </span><span class="Comment">#    </span>
<span class="FoldColumn">  </span><span class="lnr">  34 </span><span class="Comment">#issues/concerns:</span>
<span class="FoldColumn">  </span><span class="lnr">  35 </span><span class="Comment">#    this script was mostly done using the corner/spare time, extended from</span>
<span class="FoldColumn">  </span><span class="lnr">  36 </span><span class="Comment">#    a temporary script which was not designed to do the current work, that said</span>
<span class="FoldColumn">  </span><span class="lnr">  37 </span><span class="Comment">#    here are the limitations/issues:</span>
<span class="FoldColumn">  </span><span class="lnr">  38 </span><span class="Comment">#    1) no good design from start, user commands (!NNN) are not consistent</span>
<span class="FoldColumn">  </span><span class="lnr">  39 </span><span class="Comment">#       too much duplicate codes</span>
<span class="FoldColumn">  </span><span class="lnr">  40 </span><span class="Comment">#    2) too much dirty code to save time, make it not quite efficient</span>
<span class="FoldColumn">  </span><span class="lnr">  41 </span><span class="Comment">#       (global var, test/temporary/arbitrary/shortcut codes)</span>
<span class="FoldColumn">  </span><span class="lnr">  42 </span><span class="Comment">#    3) no strong error detections/preventions, the script will only work</span>
<span class="FoldColumn">  </span><span class="lnr">  43 </span><span class="Comment">#       with the way it was supposed to...</span>
<span class="FoldColumn">  </span><span class="lnr">  44 </span><span class="Comment">#    4) some features are not fully tested, might be buggy</span>
<span class="FoldColumn">  </span><span class="lnr">  45 </span><span class="Comment">#</span>
<span class="FoldColumn">  </span><span class="lnr">  46 </span><span class="Comment">#</span>
<span class="FoldColumn">  </span><span class="lnr">  47 </span><span class="Comment">#more time is needed to rewrite with cleaner codes...</span>
<span class="FoldColumn">  </span><span class="lnr">  48 </span><span class="Comment">#            pings@juniper.net </span>
<span class="FoldColumn">  </span><span class="lnr">  49 </span><span class="Comment">#</span>
<span class="FoldColumn">  </span><span class="lnr">  50 </span><span class="Comment">#            Sun Mar 13 16:31:55 EDT 2011</span>
<span class="FoldColumn">  </span><span class="lnr">  51 </span><span class="Comment">#</span>
<span class="FoldColumn">  </span><span class="lnr">  52 </span><span class="Comment">#the script is running good with simple jobs based on daily usage</span>
<span class="FoldColumn">  </span><span class="lnr">  53 </span><span class="Comment">#decision was made to stop coding unless REAL necessary</span>
<span class="FoldColumn">  </span><span class="lnr">  54 </span><span class="Comment">#            Fri Apr 22 13:41:48 EDT 2011</span>
<span class="FoldColumn">  </span><span class="lnr">  55 </span>
<span class="FoldColumn">  </span><span class="lnr">  56 </span>
<span class="FoldColumn">  </span><span class="lnr">  57 </span><span class="Comment">#global vars </span>
<span class="FoldColumn">  </span><span class="lnr">  58 </span><span class="Statement">global</span> cmds login_info CGS
<span class="FoldColumn">  </span><span class="lnr">  59 </span><span class="Statement">global</span> initlog_file host
<span class="FoldColumn">  </span><span class="lnr">  60 </span>
<span class="FoldColumn">  </span><span class="lnr">  61 </span><span class="Comment">#get script basename</span>
<span class="FoldColumn">  </span><span class="lnr">  62 </span><span class="Statement">set</span> scriptbasename [<span class="Statement">exec</span> basename <span class="Identifier">$argv0</span>]
<span class="FoldColumn">  </span><span class="lnr">  63 </span><span class="Comment">#get the prefix before &quot;.&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">  64 </span><span class="Statement">regexp</span> {(.*)\..*} <span class="Identifier">$scriptbasename</span> -&gt; scriptbasename_pref
<span class="FoldColumn">  </span><span class="lnr">  65 </span>
<span class="FoldColumn">  </span><span class="lnr">  66 </span><span class="Comment">#some tests</span>
<span class="FoldColumn">  </span><span class="lnr">  67 </span><span class="Comment">#puts &quot;script full name:-$argv0-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">  68 </span><span class="Comment">#puts &quot;script base name:-$scriptbasename-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">  69 </span><span class="Comment">#puts &quot;script base name prefix:-$scriptbasename_pref-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">  70 </span>
<span class="FoldColumn">  </span><span class="lnr">  71 </span><span class="Comment">#config file by def is located under the folder named by the script name</span>
<span class="FoldColumn">  </span><span class="lnr">  72 </span><span class="Statement">set</span> configfile <span class="Constant">&quot;~/.</span><span class="Identifier">$scriptbasename_pref</span><span class="Constant">/</span><span class="Identifier">$scriptbasename_pref</span><span class="Constant">.conf&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">  73 </span><span class="Comment">#set configfile &quot;~/.mylogin/mylogin.conf&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">  74 </span>
<span class="FoldColumn">  </span><span class="lnr">  75 </span>
<span class="FoldColumn">  </span><span class="lnr">  76 </span><span class="Comment">#modifed puts: add timestamp and procedure name for every user message printed on the terminal</span>
<span class="FoldColumn">  </span><span class="lnr">  77 </span><span class="Statement">proc</span> myputs {msg} {
<span class="FoldColumn">  </span><span class="lnr">  78 </span>    <span class="Statement">puts</span> <span class="Constant">&quot;</span><span class="Special">\[</span>[<span class="Statement">exec</span> date]<span class="Constant">:</span>[<span class="Statement">lindex</span> [<span class="Statement">info</span> level <span class="Constant">1</span>] <span class="Constant">0</span>]<span class="Constant">:..</span><span class="Identifier">$msg</span><span class="Constant">..</span><span class="Special">\]</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">  79 </span>}
<span class="FoldColumn">  </span><span class="lnr">  80 </span>
<span class="FoldColumn">  </span><span class="lnr">  81 </span><span class="Comment">#function to execute given system CLI(s)</span>
<span class="FoldColumn">  </span><span class="lnr">  82 </span><span class="Comment">#previously report file/dir doesn't exists. tcl exec really sucks!</span>
<span class="FoldColumn">  </span><span class="lnr">  83 </span><span class="Comment">#looks need that {expand} or eval exec story to make it work</span>
<span class="FoldColumn">  </span><span class="lnr">  84 </span><span class="Statement">proc</span> myexec {cmd} {
<span class="FoldColumn">  </span><span class="lnr">  85 </span>    <span class="Statement">if</span> {                                                 <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">  86 </span>        [<span class="Statement">catch</span>                                             <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">  87 </span>            {<span class="Statement">eval</span> <span class="Statement">exec</span>                                      <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">  88 </span>               <span class="Identifier">$cmd</span>                                  <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">  89 </span>            }                                              <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">  90 </span>            msg                                            <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">  91 </span>        ]                                               <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">  92 </span>        } {
<span class="FoldColumn">  </span><span class="lnr">  93 </span>       myputs <span class="Constant">&quot;Something seems to have gone wrong:&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">  94 </span>       myputs <span class="Constant">&quot;Information about it: </span><span class="Identifier">$::errorInfo</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">  95 </span>       <span class="Statement">return</span> <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">  96 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">  97 </span>        <span class="Statement">return</span> <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr">  98 </span>    }
<span class="FoldColumn">  </span><span class="lnr">  99 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 100 </span>
<span class="FoldColumn">  </span><span class="lnr"> 101 </span><span class="Comment">#add some error detection to log_file func</span>
<span class="FoldColumn">  </span><span class="lnr"> 102 </span><span class="Statement">proc</span> mylog_file {cmd} {
<span class="FoldColumn">  </span><span class="lnr"> 103 </span>    <span class="Statement">if</span> {                                                 <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr"> 104 </span>        [<span class="Statement">catch</span>                                             <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr"> 105 </span>            {                                       <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr"> 106 </span>               log_file <span class="Identifier">$cmd</span>                         <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr"> 107 </span>            }                                       <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr"> 108 </span>            msg                                            <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr"> 109 </span>        ]                                               <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr"> 110 </span>        } {
<span class="FoldColumn">  </span><span class="lnr"> 111 </span>       myputs <span class="Constant">&quot;log name is probably not valid: </span><span class="Identifier">$::errorInfo</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 112 </span>       <span class="Statement">return</span> <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 113 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 114 </span>        <span class="Statement">return</span> <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr"> 115 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 116 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 117 </span>
<span class="FoldColumn">  </span><span class="lnr"> 118 </span><span class="Comment">#send an email,with caseid as title and log files as attachment</span>
<span class="FoldColumn">  </span><span class="lnr"> 119 </span><span class="Comment">#if use zip, multiple files can be included, otherwise only 1 file is supported</span>
<span class="FoldColumn">  </span><span class="lnr"> 120 </span><span class="Comment">    #0) use {expand} to make the globbed staff as individual parameters!!</span>
<span class="FoldColumn">  </span><span class="lnr"> 121 </span><span class="Comment">    #  otherwise when glob get 2 file name there will be some strange errors!</span>
<span class="FoldColumn">  </span><span class="lnr"> 122 </span><span class="Comment">    #1) glob is required here to expand unix ~ or * in exec</span>
<span class="FoldColumn">  </span><span class="lnr"> 123 </span><span class="Comment">    #2) at least &quot;zip&quot;/&quot;uuencode&quot; and &quot;mail&quot; tools need to be a/v locally</span>
<span class="FoldColumn">  </span><span class="lnr"> 124 </span><span class="Comment">    #3) -q(quiet mode) in zip is required,</span>
<span class="FoldColumn">  </span><span class="lnr"> 125 </span><span class="Comment">    #   otherwise some error will be catched, email get sent smoothly though</span>
<span class="FoldColumn">  </span><span class="lnr"> 126 </span><span class="Comment">    #use catch to catch/skip the error and continue</span>
<span class="FoldColumn">  </span><span class="lnr"> 127 </span><span class="Comment">#procedure with default value,simpler than varible-length params precedure</span>
<span class="FoldColumn">  </span><span class="lnr"> 128 </span><span class="Statement">proc</span> sendanemail {caseid <span class="Statement">file</span> emailto {emailcc <span class="Constant">&quot;pings@juniper.net&quot;</span>}} {
<span class="FoldColumn">  </span><span class="lnr"> 129 </span>
<span class="FoldColumn">  </span><span class="lnr"> 130 </span>    <span class="Statement">global</span> DEBUG
<span class="FoldColumn">  </span><span class="lnr"> 131 </span>    <span class="Statement">global</span> zip
<span class="FoldColumn">  </span><span class="lnr"> 132 </span><span class="Comment">    #get file from glob (like unix)</span>
<span class="FoldColumn">  </span><span class="lnr"> 133 </span>    <span class="Statement">set</span> files [<span class="Statement">glob</span> <span class="Identifier">$file</span>]
<span class="FoldColumn">  </span><span class="lnr"> 134 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get file lists: </span><span class="Identifier">$files</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 135 </span><span class="Comment">    #if {[file exists [glob file]]} {</span>
<span class="FoldColumn">  </span><span class="lnr"> 136 </span>        <span class="Statement">if</span> <span class="Identifier">$zip</span> {
<span class="FoldColumn">  </span><span class="lnr"> 137 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;zip set, will send zipped file&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 138 </span>            <span class="Statement">set</span> attachname <span class="Constant">&quot;</span><span class="Identifier">$caseid</span><span class="Constant">.zip&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 139 </span>            <span class="Statement">set</span> execcmd <span class="Constant">&quot;zip -jq - {expand} </span>[<span class="Statement">glob</span> <span class="Identifier">$file</span>]<span class="Constant"> | uuencode </span><span class="Identifier">$attachname</span><span class="Constant"> | mail -s </span><span class="Special">\&quot;</span><span class="Constant">log of case:</span><span class="Identifier">$caseid</span><span class="Special">\&quot;</span><span class="Constant"> -c </span><span class="Identifier">$emailcc</span><span class="Constant"> </span><span class="Identifier">$emailto</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 140 </span>        } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 141 </span>            <span class="Statement">set</span> attachname [<span class="Statement">exec</span> basename <span class="Identifier">$files</span>]
<span class="FoldColumn">  </span><span class="lnr"> 142 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;zip not set, will send plain text file&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 143 </span><span class="Comment">            #looks only 1 file is support at a time with uuencode</span>
<span class="FoldColumn">  </span><span class="lnr"> 144 </span><span class="Comment">            #this broke after upgrading to 12.04LTS</span>
<span class="FoldColumn">  </span><span class="lnr"> 145 </span><span class="Comment">            #set execcmd &quot;uuencode [glob $file] $attachname | mail -s \&quot;log of case:$caseid\&quot; -c $emailcc $emailto&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 146 </span><span class="Comment">            #set execcmd &quot;sendemail -s pod51010.outlook.com:587 -f pings@juniper.net -t pings@juniper.net -u \&quot;log of case:$caseid\&quot; -m \&quot;this is the log file: $file\&quot; -xu pings@juniper.net -xp \&quot;EMAILPASSWORD\&quot; -o tls=auto -a [glob $file]&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 147 </span>            <span class="Statement">set</span> execcmd <span class="Constant">&quot;sendthisfile.sh </span>[<span class="Statement">glob</span> <span class="Identifier">$file</span>]<span class="Constant"> pings@juniper.net </span><span class="Special">\&quot;</span><span class="Constant">log of case:</span><span class="Identifier">$caseid</span><span class="Special">\&quot;</span><span class="Constant"> &quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 148 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 149 </span>
<span class="FoldColumn">  </span><span class="lnr"> 150 </span><span class="Comment">        #funny tcl rule, non-matching {} in comments seems also hit an error</span>
<span class="FoldColumn">  </span><span class="lnr"> 151 </span><span class="Comment">#    if {                                               \</span>
<span class="FoldColumn">  </span><span class="lnr"> 152 </span><span class="Comment">#       [catch                                             \</span>
<span class="FoldColumn">  </span><span class="lnr"> 153 </span><span class="Comment">#           {exec                                       \</span>
<span class="FoldColumn">  </span><span class="lnr"> 154 </span><span class="Comment">#             zip -jq - {expand} [glob $file]               \</span>
<span class="FoldColumn">  </span><span class="lnr"> 155 </span><span class="Comment">#                 | uuencode $caseid.zip                \</span>
<span class="FoldColumn">  </span><span class="lnr"> 156 </span><span class="Comment">#                 | mail -s &quot;log of case:$caseid&quot;       \</span>
<span class="FoldColumn">  </span><span class="lnr"> 157 </span><span class="Comment">#                    -b $emailcc $emailto             \</span>
<span class="FoldColumn">  </span><span class="lnr"> 158 </span><span class="Comment">#           }                                              \</span>
<span class="FoldColumn">  </span><span class="lnr"> 159 </span><span class="Comment">#           msg                                            \</span>
<span class="FoldColumn">  </span><span class="lnr"> 160 </span><span class="Comment">#       ]                                               \</span>
<span class="FoldColumn">  </span><span class="lnr"> 161 </span><span class="Comment">#       } {</span>
<span class="FoldColumn">  </span><span class="lnr"> 162 </span><span class="Comment">#       myputs &quot;Something seems to have gone wrong:&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 163 </span><span class="Comment">#       myputs &quot;Information about it: $::errorInfo&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 164 </span><span class="Comment">#       }</span>
<span class="FoldColumn">  </span><span class="lnr"> 165 </span>        <span class="Statement">if</span> {[myexec <span class="Identifier">$execcmd</span>]} {
<span class="FoldColumn">  </span><span class="lnr"> 166 </span>        } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 167 </span>            myputs <span class="Constant">&quot;send email to </span><span class="Identifier">$emailto</span><span class="Constant"> (and bcc </span><span class="Identifier">$emailcc</span><span class="Constant">) with logfile:</span><span class="Identifier">$files</span><span class="Constant"> as attachment:</span><span class="Identifier">$attachname</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 168 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 169 </span><span class="Comment">#    } </span>
<span class="FoldColumn">  </span><span class="lnr"> 170 </span><span class="Comment">#   else {</span>
<span class="FoldColumn">  </span><span class="lnr"> 171 </span><span class="Comment">#       myputs &quot;log file $file doesn't exist!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 172 </span><span class="Comment">#    }</span>
<span class="FoldColumn">  </span><span class="lnr"> 173 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 174 </span>
<span class="FoldColumn">  </span><span class="lnr"> 175 </span>
<span class="FoldColumn">  </span><span class="lnr"> 176 </span><span class="Statement">proc</span> usage {} {
<span class="FoldColumn">  </span><span class="lnr"> 177 </span><span class="Comment">    #$argv0 as script name become a private var here in proc w/o global</span>
<span class="FoldColumn">  </span><span class="lnr"> 178 </span>    <span class="Statement">global</span> argv0
<span class="FoldColumn">  </span><span class="lnr"> 179 </span>    myputs <span class="Constant">&quot;Usage:</span><span class="Identifier">$argv0</span><span class="Constant"> ssh|telnet|ftp|... PARAMS_LISTS&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 180 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 181 </span>
<span class="FoldColumn">  </span><span class="lnr"> 182 </span><span class="Comment">#use this as a more informative expect function</span>
<span class="FoldColumn">  </span><span class="lnr"> 183 </span><span class="Comment">#return 0 if got successful map. useful for result checking purpose</span>
<span class="FoldColumn">  </span><span class="lnr"> 184 </span><span class="Statement">proc</span> myexpect {usermsg pattern datasent timeout} {
<span class="FoldColumn">  </span><span class="lnr"> 185 </span><span class="Comment">#if pattern match, send data</span>
<span class="FoldColumn">  </span><span class="lnr"> 186 </span>    <span class="Statement">global</span> DEBUG
<span class="FoldColumn">  </span><span class="lnr"> 187 </span>    <span class="Statement">global</span> quitontimeout quitkey
<span class="FoldColumn">  </span><span class="lnr"> 188 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;-</span><span class="Identifier">$usermsg</span><span class="Constant">-,start expecting pattern:-</span><span class="Identifier">$pattern</span><span class="Constant">- to proceed with sending -</span><span class="Identifier">$datasent</span><span class="Constant">-&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 189 </span>    expect {
<span class="FoldColumn">  </span><span class="lnr"> 190 </span>        -re <span class="Constant">&quot;</span><span class="Identifier">$pattern</span><span class="Constant">&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 191 </span><span class="Comment">            #looks very important. look \r is more reliable across OS.as suggested in expect books </span>
<span class="FoldColumn">  </span><span class="lnr"> 192 </span><span class="Comment">            #\n is ok for my linux, but not work for win goodtech telnetd</span>
<span class="FoldColumn">  </span><span class="lnr"> 193 </span>            send <span class="Constant">&quot;</span><span class="Identifier">$datasent</span><span class="Special">\r</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 194 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get good match for -</span><span class="Identifier">$pattern</span><span class="Constant">- with -</span><span class="Identifier">$expect_out</span><span class="Constant">(0,string)-,sent -</span><span class="Identifier">$datasent</span><span class="Special">\\\r</span><span class="Constant">-&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 195 </span>            <span class="Statement">return</span> <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr"> 196 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 197 </span>
<span class="FoldColumn">  </span><span class="lnr"> 198 </span>        timeout {
<span class="FoldColumn">  </span><span class="lnr"> 199 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;timeout in </span><span class="Identifier">$timeout</span><span class="Constant"> seconds:no match for -</span><span class="Identifier">$pattern</span><span class="Constant">-,data -</span><span class="Identifier">$datasent</span><span class="Constant">- not sent&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 200 </span><span class="Comment">            #this is useful when the last cmd get stuck there and could be exited out of</span>
<span class="FoldColumn">  </span><span class="lnr"> 201 </span><span class="Comment">            #using some key, like &quot;q&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 202 </span>            <span class="Statement">if</span> <span class="Identifier">$quitontimeout</span> {
<span class="FoldColumn">  </span><span class="lnr"> 203 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;quit last suspended cmd before preceeding&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 204 </span>               send <span class="Constant">&quot;</span><span class="Identifier">$quitkey</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 205 </span>            }
<span class="FoldColumn">  </span><span class="lnr"> 206 </span>
<span class="FoldColumn">  </span><span class="lnr"> 207 </span>            <span class="Statement">return</span> <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 208 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 209 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 210 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 211 </span>
<span class="FoldColumn">  </span><span class="lnr"> 212 </span><span class="Comment">#use only when there are logon info for large amount of remote host, </span>
<span class="FoldColumn">  </span><span class="lnr"> 213 </span><span class="Comment">#when they can be put into a sperate/dedicated logon file.</span>
<span class="FoldColumn">  </span><span class="lnr"> 214 </span><span class="Comment">#</span>
<span class="FoldColumn">  </span><span class="lnr"> 215 </span><span class="Comment">#retrieve login info from a file and get it structured for use</span>
<span class="FoldColumn">  </span><span class="lnr"> 216 </span><span class="Comment">#upvar (ref in tcl) is used here to pass value back from proc</span>
<span class="FoldColumn">  </span><span class="lnr"> 217 </span><span class="Comment">#login_info is a global multi-dimensional array</span>
<span class="FoldColumn">  </span><span class="lnr"> 218 </span><span class="Comment"># login_info(hostname1 pattern1) = data1</span>
<span class="FoldColumn">  </span><span class="lnr"> 219 </span><span class="Comment"># login_info(hostname1 pattern2) = data2</span>
<span class="FoldColumn">  </span><span class="lnr"> 220 </span><span class="Comment"># .</span>
<span class="FoldColumn">  </span><span class="lnr"> 221 </span><span class="Statement">proc</span> get_login_info {loginfile login_info} {
<span class="FoldColumn">  </span><span class="lnr"> 222 </span><span class="Comment">    #ref it</span>
<span class="FoldColumn">  </span><span class="lnr"> 223 </span>    <span class="Statement">global</span> DEBUG
<span class="FoldColumn">  </span><span class="lnr"> 224 </span>    <span class="Statement">upvar</span> <span class="Identifier">$login_info</span> a
<span class="FoldColumn">  </span><span class="lnr"> 225 </span>    myputs <span class="Constant">&quot;grab login info from file </span><span class="Identifier">$loginfile</span><span class="Constant">-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 226 </span>    myputs <span class="Constant">&quot;open file </span><span class="Identifier">$loginfile</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 227 </span>    <span class="Statement">set</span> <span class="Statement">file</span> [<span class="Statement">open</span> <span class="Identifier">$loginfile</span> r]
<span class="FoldColumn">  </span><span class="lnr"> 228 </span>    <span class="Statement">set</span> cmd_no <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr"> 229 </span>    <span class="Statement">while</span> {[<span class="Statement">gets</span> <span class="Identifier">$file</span> line] != -<span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 230 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get a line from file:-</span><span class="Identifier">$line</span><span class="Constant">-&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 231 </span><span class="Comment">        #save the splitted line into a list</span>
<span class="FoldColumn">  </span><span class="lnr"> 232 </span>        <span class="Statement">set</span> l1 [<span class="Statement">split</span> <span class="Identifier">$line</span> <span class="Constant">&quot; &quot;</span>]
<span class="FoldColumn">  </span><span class="lnr"> 233 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {
<span class="FoldColumn">  </span><span class="lnr"> 234 </span>            myputs <span class="Constant">&quot;this line is splitted into:&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 235 </span>            myputs <span class="Constant">&quot;  -</span><span class="Identifier">$l1</span><span class="Constant">-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 236 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 237 </span><span class="Comment">        #get the 1st member out of the line,as hostname</span>
<span class="FoldColumn">  </span><span class="lnr"> 238 </span>        <span class="Statement">set</span> hostname [<span class="Statement">lindex</span> <span class="Identifier">$l1</span> <span class="Constant">0</span>]
<span class="FoldColumn">  </span><span class="lnr"> 239 </span><span class="Comment">        #get the remainder as login info</span>
<span class="FoldColumn">  </span><span class="lnr"> 240 </span>        <span class="Statement">set</span> pa_pair [<span class="Statement">lrange</span> <span class="Identifier">$l1</span> <span class="Constant">1</span> end]
<span class="FoldColumn">  </span><span class="lnr"> 241 </span><span class="Comment">        #convert the login list to an array (tcl, hash in perl)</span>
<span class="FoldColumn">  </span><span class="lnr"> 242 </span>        <span class="Statement">set</span> a(<span class="Identifier">$hostname</span>) <span class="Identifier">$pa_pair</span>
<span class="FoldColumn">  </span><span class="lnr"> 243 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 244 </span>    <span class="Statement">close</span> <span class="Identifier">$file</span>
<span class="FoldColumn">  </span><span class="lnr"> 245 </span><span class="Comment">#   return $cmd_no </span>
<span class="FoldColumn">  </span><span class="lnr"> 246 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 247 </span>
<span class="FoldColumn">  </span><span class="lnr"> 248 </span><span class="Comment">#auto login script</span>
<span class="FoldColumn">  </span><span class="lnr"> 249 </span><span class="Comment">#here global array is used directly for simplicity, </span>
<span class="FoldColumn">  </span><span class="lnr"> 250 </span><span class="Comment">#saving one proc param and upvar stuff</span>
<span class="FoldColumn">  </span><span class="lnr"> 251 </span><span class="Statement">proc</span> do_patterns_actions {host pattern_timeout dataarray pa_intv} {
<span class="FoldColumn">  </span><span class="lnr"> 252 </span>    <span class="Statement">global</span> DEBUG addclock send_initial_cr
<span class="FoldColumn">  </span><span class="lnr"> 253 </span>    <span class="Statement">upvar</span> <span class="Identifier">$dataarray</span> da
<span class="FoldColumn">  </span><span class="lnr"> 254 </span><span class="Comment">#    source ~/.mylogin/nofwd1211.conf</span>
<span class="FoldColumn">  </span><span class="lnr"> 255 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;start pattern-action sequence&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 256 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {<span class="Statement">parray</span> da}
<span class="FoldColumn">  </span><span class="lnr"> 257 </span>    <span class="Statement">if</span> <span class="Identifier">$send_initial_cr</span> {send <span class="Constant">&quot;</span><span class="Special">\r</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 258 </span>    <span class="Statement">if</span> {[<span class="Statement">info</span> exists da(<span class="Identifier">$host</span>)]} {
<span class="FoldColumn">  </span><span class="lnr"> 259 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;pattern-action data for </span><span class="Identifier">$host</span><span class="Constant"> now looks:&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 260 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;  -</span><span class="Identifier">$da</span><span class="Constant">(</span><span class="Identifier">$host</span><span class="Constant">)-&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 261 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 262 </span>        myputs <span class="Constant">&quot;pattern-action data for </span><span class="Identifier">$host</span><span class="Constant"> doesn't exist, check your config!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 263 </span>        <span class="Statement">return</span> <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 264 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 265 </span>
<span class="FoldColumn">  </span><span class="lnr"> 266 </span><span class="Comment">#   this won't work for duplicate patterns</span>
<span class="FoldColumn">  </span><span class="lnr"> 267 </span><span class="Comment">#   set i 1</span>
<span class="FoldColumn">  </span><span class="lnr"> 268 </span><span class="Comment">    #array set pa_pair $login_info($host)</span>
<span class="FoldColumn">  </span><span class="lnr"> 269 </span><span class="Comment">#    foreach pattern [array names pa_pair] {</span>
<span class="FoldColumn">  </span><span class="lnr"> 270 </span><span class="Comment">#       set datasent $pa_pair($pattern)</span>
<span class="FoldColumn">  </span><span class="lnr"> 271 </span><span class="Comment">#       myexpect &quot;pattern-action item $i\n&quot; $pattern $datasent  </span>
<span class="FoldColumn">  </span><span class="lnr"> 272 </span><span class="Comment">#       incr i</span>
<span class="FoldColumn">  </span><span class="lnr"> 273 </span><span class="Comment">#    }</span>
<span class="FoldColumn">  </span><span class="lnr"> 274 </span><span class="Comment">    #get a data list from data array</span>
<span class="FoldColumn">  </span><span class="lnr"> 275 </span>    <span class="Statement">set</span> l <span class="Identifier">$da</span>(<span class="Identifier">$host</span>)
<span class="FoldColumn">  </span><span class="lnr"> 276 </span>    <span class="Statement">set</span> j <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr"> 277 </span><span class="Comment">    #go through this data list</span>
<span class="FoldColumn">  </span><span class="lnr"> 278 </span>    <span class="Statement">for</span> {<span class="Statement">set</span> i <span class="Constant">0</span>} {<span class="Identifier">$i</span>&lt;=[<span class="Statement">expr</span> [<span class="Statement">llength</span> <span class="Identifier">$l</span>]-<span class="Constant">1</span>]} {<span class="Statement">incr</span> i <span class="Constant">2</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 279 </span><span class="Comment">        #get pattern/data</span>
<span class="FoldColumn">  </span><span class="lnr"> 280 </span>        <span class="Statement">set</span> pattern [<span class="Statement">lindex</span> <span class="Identifier">$l</span> <span class="Identifier">$i</span>]
<span class="FoldColumn">  </span><span class="lnr"> 281 </span>        <span class="Statement">set</span> datasent  [<span class="Statement">lindex</span> <span class="Identifier">$l</span> [<span class="Statement">expr</span> <span class="Identifier">$i</span>+<span class="Constant">1</span>]]
<span class="FoldColumn">  </span><span class="lnr"> 282 </span><span class="Comment">        #execute the pattern-data pairs</span>
<span class="FoldColumn">  </span><span class="lnr"> 283 </span>        <span class="Statement">if</span> <span class="Identifier">$addclock</span> {
<span class="FoldColumn">  </span><span class="lnr"> 284 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> { myputs <span class="Constant">&quot;send a clock&quot;</span> }
<span class="FoldColumn">  </span><span class="lnr"> 285 </span>            send <span class="Constant">&quot;</span><span class="Identifier">$clockcmd</span><span class="Special">\r</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 286 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 287 </span>        myexpect <span class="Constant">&quot;pattern-action item </span><span class="Identifier">$j</span><span class="Constant">&quot;</span> <span class="Identifier">$pattern</span> <span class="Identifier">$datasent</span> <span class="Identifier">$pattern_timeout</span>
<span class="FoldColumn">  </span><span class="lnr"> 288 </span><span class="Comment">        #if $DEBUG {myputs &quot;pattern-action item $j&quot;}</span>
<span class="FoldColumn">  </span><span class="lnr"> 289 </span><span class="Comment">        #do_cmd $pattern $datasent $pattern_timeout</span>
<span class="FoldColumn">  </span><span class="lnr"> 290 </span>        <span class="Statement">incr</span> j
<span class="FoldColumn">  </span><span class="lnr"> 291 </span><span class="Comment">        #optionally pause between each step</span>
<span class="FoldColumn">  </span><span class="lnr"> 292 </span>        sleep <span class="Identifier">$pa_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 293 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 294 </span>
<span class="FoldColumn">  </span><span class="lnr"> 295 </span><span class="Comment">    #this is to garrantee we can get the prompt for the last cmd to finish</span>
<span class="FoldColumn">  </span><span class="lnr"> 296 </span><span class="Comment">    #otherwise the output of it will be held unless next cmd was inputted</span>
<span class="FoldColumn">  </span><span class="lnr"> 297 </span><span class="Comment">    #this works in most cases:</span>
<span class="FoldColumn">  </span><span class="lnr"> 298 </span><span class="Comment">    #myexpect &quot;extra return&quot; $pattern &quot;\r&quot; $pattern_timeout</span>
<span class="FoldColumn">  </span><span class="lnr"> 299 </span><span class="Comment">    #but this is better:</span>
<span class="FoldColumn">  </span><span class="lnr"> 300 </span>    myexpect <span class="Constant">&quot;extra return&quot;</span> <span class="Constant">&quot;.*&quot;</span> <span class="Constant">&quot;</span><span class="Special">\r</span><span class="Constant">&quot;</span> <span class="Identifier">$pattern_timeout</span>
<span class="FoldColumn">  </span><span class="lnr"> 301 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 302 </span>
<span class="FoldColumn">  </span><span class="lnr"> 303 </span><span class="Statement">proc</span> repeat_patterns_actions {maxrounds host pattern_timeout dataarray pa_intv} {
<span class="FoldColumn">  </span><span class="lnr"> 304 </span>    myputs <span class="Constant">&quot;</span><span class="Identifier">$maxrounds</span><span class="Constant"> rounds of patterns_actions_list will be executed&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 305 </span>    <span class="Statement">set</span> i <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 306 </span>    <span class="Statement">upvar</span> <span class="Identifier">$dataarray</span> ref
<span class="FoldColumn">  </span><span class="lnr"> 307 </span>    <span class="Statement">while</span> {<span class="Identifier">$i</span>&lt;=<span class="Identifier">$maxrounds</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 308 </span>        do_patterns_actions <span class="Identifier">$host</span> <span class="Identifier">$pattern_timeout</span> ref <span class="Identifier">$pa_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 309 </span>        myputs <span class="Constant">&quot;</span><span class="Special">\n\n</span><span class="Constant">..#####################################..</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 310 </span>        myputs <span class="Constant">&quot;this is rounds </span><span class="Identifier">$i</span><span class="Constant"> of patterns_actions_list execution..</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 311 </span>        myputs <span class="Constant">&quot;..#####################################..</span><span class="Special">\n\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 312 </span>
<span class="FoldColumn">  </span><span class="lnr"> 313 </span><span class="Comment">        #this doesn't work</span>
<span class="FoldColumn">  </span><span class="lnr"> 314 </span><span class="Comment">#       trap {send_user &quot;bye&quot;; exit} SIGINT</span>
<span class="FoldColumn">  </span><span class="lnr"> 315 </span>        <span class="Statement">incr</span> i
<span class="FoldColumn">  </span><span class="lnr"> 316 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 317 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 318 </span>
<span class="FoldColumn">  </span><span class="lnr"> 319 </span><span class="Comment">#set PAGS(e320-1)            {pa_list1 pa_list2}</span>
<span class="FoldColumn">  </span><span class="lnr"> 320 </span><span class="Comment">#set pa_list1(HRNDVA-FIOS-2)    {# &quot;config t&quot; config &quot;do show clock&quot; config exit}</span>
<span class="FoldColumn">  </span><span class="lnr"> 321 </span><span class="Comment">#set pa_list2(HRNDVA-FIOS-2)    {# &quot;config t&quot; config &quot;do show red&quot; config exit}</span>
<span class="FoldColumn">  </span><span class="lnr"> 322 </span><span class="Comment">#set pa_list1(e320-1)    {# &quot;config t&quot; config &quot;do show clock&quot; config exit}</span>
<span class="FoldColumn">  </span><span class="lnr"> 323 </span><span class="Comment">#set pa_list2(e320-1)    {# &quot;config t&quot; config &quot;do show red&quot; config exit}</span>
<span class="FoldColumn">  </span><span class="lnr"> 324 </span><span class="Comment">#this function is depressed by its new version and hence obsolete</span>
<span class="FoldColumn">  </span><span class="lnr"> 325 </span><span class="Statement">proc</span> do_pags_original_obsolete {pags host pattern_timeout pa_intv} {
<span class="FoldColumn">  </span><span class="lnr"> 326 </span>
<span class="FoldColumn">  </span><span class="lnr"> 327 </span>    <span class="Statement">global</span> DEBUG NEWFEATURE
<span class="FoldColumn">  </span><span class="lnr"> 328 </span><span class="Comment">    #pass the array via upvar (ref)</span>
<span class="FoldColumn">  </span><span class="lnr"> 329 </span>    <span class="Statement">upvar</span> <span class="Identifier">$pags</span> PAGS
<span class="FoldColumn">  </span><span class="lnr"> 330 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get pattern action groups from list(PAGS):-</span><span class="Identifier">$PAGS</span><span class="Constant">(</span><span class="Identifier">$host</span><span class="Constant">)-&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 331 </span>
<span class="FoldColumn">  </span><span class="lnr"> 332 </span>    <span class="Statement">foreach</span> pa_group <span class="Identifier">$PAGS</span>(<span class="Identifier">$host</span>) {
<span class="FoldColumn">  </span><span class="lnr"> 333 </span><span class="Comment">        #this worked, but ugly, in terms of using global var like this</span>
<span class="FoldColumn">  </span><span class="lnr"> 334 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get a pa_group </span><span class="Identifier">$pa_group</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 335 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;executed eval global </span><span class="Identifier">$pa_group</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 336 </span>        <span class="Statement">eval</span> <span class="Statement">global</span> <span class="Identifier">$pa_group</span>
<span class="FoldColumn">  </span><span class="lnr"> 337 </span>
<span class="FoldColumn">  </span><span class="lnr"> 338 </span>        do_patterns_actions <span class="Identifier">$host</span> <span class="Identifier">$pattern_timeout</span> <span class="Identifier">$pa_group</span> <span class="Identifier">$pa_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 339 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 340 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 341 </span>
<span class="FoldColumn">  </span><span class="lnr"> 342 </span>
<span class="FoldColumn">  </span><span class="lnr"> 343 </span><span class="Statement">proc</span> do_pags {pags host pattern_timeout pa_intv} {
<span class="FoldColumn">  </span><span class="lnr"> 344 </span>
<span class="FoldColumn">  </span><span class="lnr"> 345 </span>    <span class="Statement">global</span> DEBUG NEWFEATURE configfile
<span class="FoldColumn">  </span><span class="lnr"> 346 </span><span class="Comment">    #pass the array via upvar (ref)</span>
<span class="FoldColumn">  </span><span class="lnr"> 347 </span>    <span class="Statement">upvar</span> <span class="Identifier">$pags</span> PAGS
<span class="FoldColumn">  </span><span class="lnr"> 348 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get pattern action groups from :-</span><span class="Identifier">$PAGS</span><span class="Constant">(</span><span class="Identifier">$host</span><span class="Constant">)-&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 349 </span>
<span class="FoldColumn">  </span><span class="lnr"> 350 </span><span class="Comment">    #source $configfile</span>
<span class="FoldColumn">  </span><span class="lnr"> 351 </span>
<span class="FoldColumn">  </span><span class="lnr"> 352 </span>    <span class="Statement">if</span> {[<span class="Statement">regexp</span> <span class="Constant">&quot;^E_&quot;</span> <span class="Identifier">$pags</span>]} {
<span class="FoldColumn">  </span><span class="lnr"> 353 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;this pa_group </span><span class="Identifier">$pa_group</span><span class="Constant"> is end 'leaf' node,execute it...&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 354 </span>        do_patterns_actions <span class="Identifier">$host</span> <span class="Identifier">$pattern_timeout</span> <span class="Identifier">$PAGS</span> <span class="Identifier">$pa_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 355 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 356 </span>        <span class="Statement">foreach</span> pa_group <span class="Identifier">$PAGS</span>(<span class="Identifier">$host</span>) {
<span class="FoldColumn">  </span><span class="lnr"> 357 </span>            <span class="Statement">if</span> {[<span class="Statement">regexp</span> <span class="Constant">&quot;^E_&quot;</span> <span class="Identifier">$pa_group</span>]} {
<span class="FoldColumn">  </span><span class="lnr"> 358 </span><span class="Comment">               #this worked, but ugly, in terms of using global var like this</span>
<span class="FoldColumn">  </span><span class="lnr"> 359 </span><span class="Comment">               #</span>
<span class="FoldColumn">  </span><span class="lnr"> 360 </span>               <span class="Statement">if</span> {[<span class="Statement">info</span> exists pa_group(<span class="Identifier">$host</span>)] == -<span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 361 </span>                   myputs <span class="Constant">&quot;the pattern action group </span><span class="Identifier">$pa_group</span><span class="Constant"> is not configured,check your config!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 362 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 363 </span>                   <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get a pa_group </span><span class="Identifier">$pa_group</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 364 </span>                   <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;executed eval global </span><span class="Identifier">$pa_group</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 365 </span>                   <span class="Statement">eval</span> <span class="Statement">global</span> <span class="Identifier">$pa_group</span>
<span class="FoldColumn">  </span><span class="lnr"> 366 </span>                   <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;this pa_group </span><span class="Identifier">$pa_group</span><span class="Constant"> is end 'leaf' node,execute it...&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 367 </span>                   do_patterns_actions <span class="Identifier">$host</span> <span class="Identifier">$pattern_timeout</span> <span class="Identifier">$pa_group</span> <span class="Identifier">$pa_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 368 </span><span class="Comment">                   #unset $pa_group</span>
<span class="FoldColumn">  </span><span class="lnr"> 369 </span>               }
<span class="FoldColumn">  </span><span class="lnr"> 370 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 371 </span>               <span class="Statement">if</span> {[<span class="Statement">info</span> exists pa_group(<span class="Identifier">$host</span>)] == -<span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 372 </span>                   myputs <span class="Constant">&quot;the pattern action group </span><span class="Identifier">$pa_group</span><span class="Constant"> is not configured,check your config!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 373 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 374 </span>                   <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get a pa_group </span><span class="Identifier">$pa_group</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 375 </span>                   <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;executed eval global </span><span class="Identifier">$pa_group</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 376 </span>                   <span class="Statement">eval</span> <span class="Statement">global</span> <span class="Identifier">$pa_group</span>
<span class="FoldColumn">  </span><span class="lnr"> 377 </span>                   <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;this pa_group </span><span class="Identifier">$pa_group</span><span class="Constant"> contains more sub-groups,resolve further...&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 378 </span>                   do_pags <span class="Identifier">$pa_group</span> <span class="Identifier">$host</span> <span class="Identifier">$pattern_timeout</span> <span class="Identifier">$pa_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 379 </span>               }
<span class="FoldColumn">  </span><span class="lnr"> 380 </span>            }
<span class="FoldColumn">  </span><span class="lnr"> 381 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 382 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 383 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 384 </span>
<span class="FoldColumn">  </span><span class="lnr"> 385 </span><span class="Statement">proc</span> repeat_pags {maxrounds pags host pattern_timeout pa_intv pags_intv} {
<span class="FoldColumn">  </span><span class="lnr"> 386 </span>    myputs <span class="Constant">&quot;</span><span class="Identifier">$maxrounds</span><span class="Constant"> rounds of pattern action groups will be executed&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 387 </span>    <span class="Statement">upvar</span> <span class="Identifier">$pags</span> PAGS
<span class="FoldColumn">  </span><span class="lnr"> 388 </span>    <span class="Statement">set</span> i <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 389 </span>    <span class="Statement">while</span> {<span class="Identifier">$i</span>&lt;=<span class="Identifier">$maxrounds</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 390 </span>        do_pags PAGS <span class="Identifier">$host</span> <span class="Identifier">$pattern_timeout</span> <span class="Identifier">$pa_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 391 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;</span><span class="Special">\n\n</span><span class="Constant">..#####################################..</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 392 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;this is rounds </span><span class="Identifier">$i</span><span class="Constant"> of pattern action group..</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 393 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;..#####################################..</span><span class="Special">\n\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 394 </span>
<span class="FoldColumn">  </span><span class="lnr"> 395 </span>        sleep <span class="Identifier">$pags_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 396 </span>
<span class="FoldColumn">  </span><span class="lnr"> 397 </span><span class="Comment">        #wanted to stop the loop anytime,this doesn't work yet</span>
<span class="FoldColumn">  </span><span class="lnr"> 398 </span><span class="Comment">#       trap {send_user &quot;bye&quot;; exit} SIGINT</span>
<span class="FoldColumn">  </span><span class="lnr"> 399 </span>        <span class="Statement">incr</span> i
<span class="FoldColumn">  </span><span class="lnr"> 400 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 401 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 402 </span>
<span class="FoldColumn">  </span><span class="lnr"> 403 </span><span class="Statement">proc</span> do_autologin_retry {max_login_retry success_login_pattern login_timeout pa_intv} {
<span class="FoldColumn">  </span><span class="lnr"> 404 </span>    <span class="Statement">global</span> login_info
<span class="FoldColumn">  </span><span class="lnr"> 405 </span>    <span class="Statement">set</span> i <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 406 </span>    <span class="Statement">while</span> {<span class="Identifier">$i</span>&lt;=<span class="Identifier">$max_login_retry</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 407 </span><span class="Comment">    #check the login result to see if a retry is needed</span>
<span class="FoldColumn">  </span><span class="lnr"> 408 </span><span class="Comment">    #again, tcl syntax: \\~ for ~ ; \\$ for $, \\\\ for \, etc.. to match ping@640g-laptop:~$</span>
<span class="FoldColumn">  </span><span class="lnr"> 409 </span><span class="Comment">    #set success_pattern &quot;laptop:\\~*\\$&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 410 </span>        <span class="Statement">set</span> autologin_fail [myexpect <span class="Constant">&quot;check if login success after retry </span><span class="Identifier">$i</span><span class="Constant">&quot;</span> <span class="Identifier">$success_login_pattern</span> <span class="Constant">&quot;</span><span class="Special">\r</span><span class="Constant">&quot;</span> <span class="Identifier">$login_timeout</span>]
<span class="FoldColumn">  </span><span class="lnr"> 411 </span><span class="Comment">        #if failed, but still within retry limit, retry login</span>
<span class="FoldColumn">  </span><span class="lnr"> 412 </span>        <span class="Statement">if</span> <span class="Identifier">$autologin_fail</span> {
<span class="FoldColumn">  </span><span class="lnr"> 413 </span>            <span class="Statement">puts</span> <span class="Constant">&quot;..last login failed..will retry </span><span class="Identifier">$i</span><span class="Constant">/</span><span class="Identifier">$max_login_retry</span><span class="Constant"> time(s) </span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 414 </span>            do_patterns_actions <span class="Identifier">$hostname</span> <span class="Identifier">$login_timeout</span> login_info <span class="Identifier">$pa_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 415 </span>        } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 416 </span><span class="Comment">            #if get through, go out of loop and continue</span>
<span class="FoldColumn">  </span><span class="lnr"> 417 </span>            <span class="Statement">set</span> login_retry_fail <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr"> 418 </span>            <span class="Statement">break</span>
<span class="FoldColumn">  </span><span class="lnr"> 419 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 420 </span><span class="Comment">        #if max retry is reached,go interact</span>
<span class="FoldColumn">  </span><span class="lnr"> 421 </span>        <span class="Statement">if</span> {<span class="Identifier">$ieq$max_login_retry</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 422 </span>            <span class="Statement">puts</span> <span class="Constant">&quot;..max login retry times(</span><span class="Identifier">$max_login_retry</span><span class="Constant">) reached..</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 423 </span>            <span class="Statement">set</span> login_retry_fail <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 424 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 425 </span>        <span class="Statement">incr</span> i
<span class="FoldColumn">  </span><span class="lnr"> 426 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 427 </span>
<span class="FoldColumn">  </span><span class="lnr"> 428 </span>    <span class="Statement">return</span> <span class="Identifier">$login_retry_fail</span>
<span class="FoldColumn">  </span><span class="lnr"> 429 </span>
<span class="FoldColumn">  </span><span class="lnr"> 430 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 431 </span>
<span class="FoldColumn">  </span><span class="lnr"> 432 </span><span class="Comment">#execute a single command, with patience of a given time</span>
<span class="FoldColumn">  </span><span class="lnr"> 433 </span><span class="Statement">proc</span> do_cmd {pattern cmd timeout1} {
<span class="FoldColumn">  </span><span class="lnr"> 434 </span><span class="Comment">#if use do_cmd {...timeout}, then</span>
<span class="FoldColumn">  </span><span class="lnr"> 435 </span><span class="Comment">#no need to set explicitly due to the sepcialty of var timeout in proc param</span>
<span class="FoldColumn">  </span><span class="lnr"> 436 </span><span class="Comment">#   set timeout $timeout1       - this is no need</span>
<span class="FoldColumn">  </span><span class="lnr"> 437 </span><span class="Comment">#but for simplicity we can bypass this machnism and use another var name like timeout1</span>
<span class="FoldColumn">  </span><span class="lnr"> 438 </span>
<span class="FoldColumn">  </span><span class="lnr"> 439 </span>    <span class="Statement">global</span> DEBUG NEWFEATURE addclock clockcmd prefix_cr_for_each_cmd
<span class="FoldColumn">  </span><span class="lnr"> 440 </span><span class="Comment">    #this is to garantee we got the right prompt before proceed</span>
<span class="FoldColumn">  </span><span class="lnr"> 441 </span><span class="Comment">    #don't know why, but the clockcmd lose 1st CHs from time to time</span>
<span class="FoldColumn">  </span><span class="lnr"> 442 </span><span class="Comment">    #use these non-sense stuff to feed that</span>
<span class="FoldColumn">  </span><span class="lnr"> 443 </span><span class="Comment">    #send &quot;!!!!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 444 </span><span class="Comment">    #</span>
<span class="FoldColumn">  </span><span class="lnr"> 445 </span>    <span class="Statement">if</span> <span class="Identifier">$prefix_cr_for_each_cmd</span> {send <span class="Constant">&quot;</span><span class="Special">\r</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 446 </span>
<span class="FoldColumn">  </span><span class="lnr"> 447 </span>
<span class="FoldColumn">  </span><span class="lnr"> 448 </span>    <span class="Statement">if</span> <span class="Identifier">$addclock</span> {
<span class="FoldColumn">  </span><span class="lnr"> 449 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> { myputs <span class="Constant">&quot;send a clock&quot;</span> }
<span class="FoldColumn">  </span><span class="lnr"> 450 </span>        send <span class="Constant">&quot;</span><span class="Identifier">$clockcmd</span><span class="Special">\r</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 451 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 452 </span>
<span class="FoldColumn">  </span><span class="lnr"> 453 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {
<span class="FoldColumn">  </span><span class="lnr"> 454 </span>        myputs <span class="Constant">&quot;next cmd:-</span><span class="Identifier">$cmd</span><span class="Constant">-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 455 </span>        myputs <span class="Constant">&quot;will check prompt for cmd -</span><span class="Identifier">$cmd</span><span class="Constant">-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 456 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 457 </span>
<span class="FoldColumn">  </span><span class="lnr"> 458 </span>    <span class="Statement">set</span> result [myexpect <span class="Constant">&quot;checking prompt for -</span><span class="Identifier">$cmd</span><span class="Constant">-&quot;</span> <span class="Identifier">$pattern</span> <span class="Identifier">$cmd</span> <span class="Identifier">$timeout1</span>]
<span class="FoldColumn">  </span><span class="lnr"> 459 </span>    <span class="Statement">return</span> result
<span class="FoldColumn">  </span><span class="lnr"> 460 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 461 </span>
<span class="FoldColumn">  </span><span class="lnr"> 462 </span>
<span class="FoldColumn">  </span><span class="lnr"> 463 </span><span class="Comment">#get cmds out of cmds file, use global var(no ref) to pass value back</span>
<span class="FoldColumn">  </span><span class="lnr"> 464 </span><span class="Statement">proc</span> get_cmds {cmdsfile cmds} {
<span class="FoldColumn">  </span><span class="lnr"> 465 </span>    <span class="Statement">global</span> DEBUG
<span class="FoldColumn">  </span><span class="lnr"> 466 </span>    <span class="Statement">upvar</span> <span class="Identifier">$cmds</span> a
<span class="FoldColumn">  </span><span class="lnr"> 467 </span>    myputs <span class="Constant">&quot;grab cmds from file </span><span class="Identifier">$cmdsfile</span><span class="Constant">-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 468 </span>    myputs <span class="Constant">&quot;open file </span><span class="Identifier">$cmdsfile</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 469 </span>    <span class="Statement">set</span> <span class="Statement">file</span> [<span class="Statement">open</span> <span class="Identifier">$cmdsfile</span> r]
<span class="FoldColumn">  </span><span class="lnr"> 470 </span>    <span class="Statement">set</span> cmd_no <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr"> 471 </span>    <span class="Statement">while</span> {[<span class="Statement">gets</span> <span class="Identifier">$file</span> line] != -<span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 472 </span>        <span class="Statement">if</span> (<span class="Identifier">$DEBUG</span>) {myputs <span class="Constant">&quot;get a line from file:-</span><span class="Identifier">$line</span><span class="Constant">-&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 473 </span>        <span class="Statement">set</span> a(<span class="Identifier">$cmd_no</span>) <span class="Identifier">$line</span>
<span class="FoldColumn">  </span><span class="lnr"> 474 </span>        <span class="Statement">incr</span> cmd_no
<span class="FoldColumn">  </span><span class="lnr"> 475 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 476 </span>    <span class="Statement">close</span> <span class="Identifier">$file</span>
<span class="FoldColumn">  </span><span class="lnr"> 477 </span>    <span class="Statement">return</span> <span class="Identifier">$cmd_no</span>
<span class="FoldColumn">  </span><span class="lnr"> 478 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 479 </span>
<span class="FoldColumn">  </span><span class="lnr"> 480 </span>
<span class="FoldColumn">  </span><span class="lnr"> 481 </span><span class="Comment">#get cmds from either config file,or n/a, from another file, </span>
<span class="FoldColumn">  </span><span class="lnr"> 482 </span><span class="Comment">#here use global var to get value from proc</span>
<span class="FoldColumn">  </span><span class="lnr"> 483 </span><span class="Statement">proc</span> loaddata {datafile data_type data} {
<span class="FoldColumn">  </span><span class="lnr"> 484 </span>    <span class="Statement">global</span> DEBUG cmds login_info
<span class="FoldColumn">  </span><span class="lnr"> 485 </span>    <span class="Statement">upvar</span> <span class="Identifier">$data</span> a
<span class="FoldColumn">  </span><span class="lnr"> 486 </span>
<span class="FoldColumn">  </span><span class="lnr"> 487 </span>    <span class="Statement">if</span> {[<span class="Statement">array</span> size a] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 488 </span>        <span class="Statement">if</span> {[<span class="Statement">catch</span> {<span class="Statement">source</span> <span class="Identifier">$datafile</span>} msg]} {
<span class="FoldColumn">  </span><span class="lnr"> 489 </span><span class="Comment">            #file is not in tcl syntax</span>
<span class="FoldColumn">  </span><span class="lnr"> 490 </span>            <span class="Statement">puts</span> <span class="Constant">&quot;file </span><span class="Identifier">$datafile</span><span class="Constant"> is not with correct syntax&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 491 </span>            <span class="Statement">puts</span> <span class="Constant">&quot;..try to read each line as pure </span><span class="Identifier">$data_type</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 492 </span>
<span class="FoldColumn">  </span><span class="lnr"> 493 </span>            <span class="Statement">if</span> {<span class="Identifier">$data_type</span> eq <span class="Constant">&quot;cmds&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 494 </span>               get_cmds <span class="Identifier">$datafile</span> cmds
<span class="FoldColumn">  </span><span class="lnr"> 495 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 496 </span>               get_logininfo <span class="Identifier">$datafile</span> login_info
<span class="FoldColumn">  </span><span class="lnr"> 497 </span>            }
<span class="FoldColumn">  </span><span class="lnr"> 498 </span>
<span class="FoldColumn">  </span><span class="lnr"> 499 </span>        } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 500 </span>            <span class="Statement">puts</span> <span class="Constant">&quot;file </span><span class="Identifier">$datafile</span><span class="Constant"> is with good syntax, well loaded&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 501 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 502 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 503 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {<span class="Statement">puts</span> <span class="Constant">&quot;got data already(from config file),no need to read/source file </span><span class="Identifier">$datafile</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 504 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 505 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {
<span class="FoldColumn">  </span><span class="lnr"> 506 </span>        myputs <span class="Constant">&quot;got following </span><span class="Identifier">$data_type</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 507 </span>        <span class="Statement">parray</span> a
<span class="FoldColumn">  </span><span class="lnr"> 508 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 509 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 510 </span>
<span class="FoldColumn">  </span><span class="lnr"> 511 </span>
<span class="FoldColumn">  </span><span class="lnr"> 512 </span>
<span class="FoldColumn">  </span><span class="lnr"> 513 </span><span class="Comment">#executes commands in batch, with given interval bet each cmd</span>
<span class="FoldColumn">  </span><span class="lnr"> 514 </span><span class="Comment">#use upvar(ref) to pass array as a parameter</span>
<span class="FoldColumn">  </span><span class="lnr"> 515 </span><span class="Comment">#w/o ref seems not working</span>
<span class="FoldColumn">  </span><span class="lnr"> 516 </span><span class="Statement">proc</span> do_cmds {pattern cmds cmd_interval waittime} {
<span class="FoldColumn">  </span><span class="lnr"> 517 </span>    <span class="Statement">global</span> DEBUG send_initial_cr
<span class="FoldColumn">  </span><span class="lnr"> 518 </span>    <span class="Statement">upvar</span> <span class="Identifier">$cmds</span> ref
<span class="FoldColumn">  </span><span class="lnr"> 519 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {
<span class="FoldColumn">  </span><span class="lnr"> 520 </span>        myputs <span class="Constant">&quot;start to do_following batch cmds:&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 521 </span>        <span class="Statement">parray</span> ref
<span class="FoldColumn">  </span><span class="lnr"> 522 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 523 </span>
<span class="FoldColumn">  </span><span class="lnr"> 524 </span>    <span class="Statement">set</span> i <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr"> 525 </span>    <span class="Statement">if</span> <span class="Identifier">$send_initial_cr</span> {send <span class="Constant">&quot;</span><span class="Special">\r</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 526 </span><span class="Comment">    #by def tcl will use ascii sequence to sort the list</span>
<span class="FoldColumn">  </span><span class="lnr"> 527 </span><span class="Comment">    #resort the array index/key w/ numerically increasing order is more convenient to control the cmd orders</span>
<span class="FoldColumn">  </span><span class="lnr"> 528 </span>    <span class="Statement">foreach</span> cmd_no [<span class="Statement">lsort</span> -integer [<span class="Statement">array</span> name ref]] {
<span class="FoldColumn">  </span><span class="lnr"> 529 </span>        <span class="Statement">incr</span> i
<span class="FoldColumn">  </span><span class="lnr"> 530 </span>        <span class="Statement">set</span> onecmd <span class="Identifier">$ref</span>(<span class="Identifier">$cmd_no</span>)
<span class="FoldColumn">  </span><span class="lnr"> 531 </span><span class="Comment">        #if no value, just skip and do nothing, otherwise send it</span>
<span class="FoldColumn">  </span><span class="lnr"> 532 </span><span class="Comment">        #it looks these compare agaist empty is not necessary in tcl</span>
<span class="FoldColumn">  </span><span class="lnr"> 533 </span>        <span class="Statement">if</span> {[<span class="Statement">string</span> compare <span class="Identifier">$onecmd</span> <span class="Constant">&quot;&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 534 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;NO</span><span class="Identifier">$i</span><span class="Constant">:ID</span><span class="Identifier">$cmd_no</span><span class="Constant">:get an empty cmd,skip it and do nothing&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 535 </span>        } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 536 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;NO</span><span class="Identifier">$i</span><span class="Constant">:ID</span><span class="Identifier">$cmd_no</span><span class="Constant">:get an cmd:</span><span class="Identifier">$onecmd</span><span class="Constant">,send it&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 537 </span>            do_cmd <span class="Identifier">$pattern</span> <span class="Identifier">$onecmd</span> <span class="Identifier">$waittime</span>
<span class="FoldColumn">  </span><span class="lnr"> 538 </span>            sleep <span class="Identifier">$cmd_interval</span>
<span class="FoldColumn">  </span><span class="lnr"> 539 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 540 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 541 </span><span class="Comment">    #this is to garrantee we can get the prompt for the last cmd to finishe</span>
<span class="FoldColumn">  </span><span class="lnr"> 542 </span><span class="Comment">    #otherwise the output of it will be delayed!</span>
<span class="FoldColumn">  </span><span class="lnr"> 543 </span>    do_cmd <span class="Identifier">$pattern</span> <span class="Constant">&quot;</span><span class="Special">\r</span><span class="Constant">&quot;</span> <span class="Identifier">$waittime</span>
<span class="FoldColumn">  </span><span class="lnr"> 544 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 545 </span>
<span class="FoldColumn">  </span><span class="lnr"> 546 </span><span class="Comment">#execute a list of cmds groups, recursively</span>
<span class="FoldColumn">  </span><span class="lnr"> 547 </span><span class="Statement">proc</span> do_cmds_groups {pattern cmds_group_list cmds_groups_intv cmd_interval waittime} {
<span class="FoldColumn">  </span><span class="lnr"> 548 </span>    <span class="Statement">global</span> DEBUG NEWFEATURE configfile
<span class="FoldColumn">  </span><span class="lnr"> 549 </span><span class="Comment">    #since CGS is a list, not an array, so passing it like a var</span>
<span class="FoldColumn">  </span><span class="lnr"> 550 </span><span class="Comment">    #no need upvar(for array this is needed)</span>
<span class="FoldColumn">  </span><span class="lnr"> 551 </span><span class="Comment">    #upvar $CGS ref</span>
<span class="FoldColumn">  </span><span class="lnr"> 552 </span>
<span class="FoldColumn">  </span><span class="lnr"> 553 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;start to get cmds groups from cmds_groups_list:-</span><span class="Identifier">$cmds_group_list</span><span class="Constant">-&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 554 </span><span class="Comment">    #set CGS {ospf isis}</span>
<span class="FoldColumn">  </span><span class="lnr"> 555 </span><span class="Comment">    #dirty, but working method, to get exact update of each cmd_group(ospf, isis)</span>
<span class="FoldColumn">  </span><span class="lnr"> 556 </span><span class="Comment">    #may introduce too much unuseful vars into this proc</span>
<span class="FoldColumn">  </span><span class="lnr"> 557 </span>    <span class="Statement">source</span> <span class="Identifier">$configfile</span>
<span class="FoldColumn">  </span><span class="lnr"> 558 </span>
<span class="FoldColumn">  </span><span class="lnr"> 559 </span>    <span class="Statement">foreach</span> cmds_group <span class="Identifier">$cmds_group_list</span> {
<span class="FoldColumn">  </span><span class="lnr"> 560 </span>
<span class="FoldColumn">  </span><span class="lnr"> 561 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get a group </span><span class="Identifier">$cmds_group</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 562 </span>
<span class="FoldColumn">  </span><span class="lnr"> 563 </span><span class="Comment">        #this worked, but ugly, in terms of using global var like this </span>
<span class="FoldColumn">  </span><span class="lnr"> 564 </span><span class="Comment">        #to get cmds_group, eg. ospf, isis</span>
<span class="FoldColumn">  </span><span class="lnr"> 565 </span><span class="Comment">        #if $DEBUG {myputs &quot;executed eval global $cmds_group&quot;}</span>
<span class="FoldColumn">  </span><span class="lnr"> 566 </span><span class="Comment">        #eval global $cmds_group</span>
<span class="FoldColumn">  </span><span class="lnr"> 567 </span>        <span class="Statement">if</span> {[<span class="Statement">regexp</span> <span class="Constant">&quot;^E_&quot;</span> <span class="Identifier">$cmds_group</span>]} {
<span class="FoldColumn">  </span><span class="lnr"> 568 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;</span><span class="Identifier">$cmds_group</span><span class="Constant"> is an end leaf node&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 569 </span>            do_cmds <span class="Identifier">$pattern</span> <span class="Identifier">$cmds_group</span> <span class="Identifier">$cmd_interval</span> <span class="Identifier">$waittime</span>
<span class="FoldColumn">  </span><span class="lnr"> 570 </span>        } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 571 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;</span><span class="Identifier">$cmds_group</span><span class="Constant"> is not an end node,resolve further...&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 572 </span>            do_cmds_groups <span class="Identifier">$pattern</span> [<span class="Statement">set</span> <span class="Identifier">$cmds_group</span>] <span class="Identifier">$cmds_groups_intv</span> <span class="Identifier">$cmd_interval</span> <span class="Identifier">$waittime</span>
<span class="FoldColumn">  </span><span class="lnr"> 573 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 574 </span>
<span class="FoldColumn">  </span><span class="lnr"> 575 </span>        <span class="Statement">if</span> <span class="Identifier">$NEWFEATURE</span> {
<span class="FoldColumn">  </span><span class="lnr"> 576 </span>        <span class="Statement">foreach</span> cmd_no [<span class="Statement">lsort</span> -integer [<span class="Statement">array</span> name [<span class="Statement">set</span> cmds_group]]] {
<span class="FoldColumn">  </span><span class="lnr"> 577 </span><span class="Comment">            #set ospf(0)                     &quot;show ip ospf&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 578 </span><span class="Comment">            #set ospf(1)                     &quot;show ip ospf nei&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 579 </span><span class="Comment">            #use [set var] to do some eval-like work inside some code</span>
<span class="FoldColumn">  </span><span class="lnr"> 580 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get #</span><span class="Identifier">$cmd_no</span><span class="Constant"> cmd:</span>[<span class="Statement">set</span> [<span class="Statement">set</span> cmds_group](<span class="Identifier">$cmd_no</span>)]<span class="Constant"> from the group&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 581 </span>            do_cmd <span class="Identifier">$pattern</span> [<span class="Statement">set</span> [<span class="Statement">set</span> cmds_group](<span class="Identifier">$cmd_no</span>)] <span class="Identifier">$waittime</span>
<span class="FoldColumn">  </span><span class="lnr"> 582 </span>            sleep <span class="Identifier">$cmd_interval</span>
<span class="FoldColumn">  </span><span class="lnr"> 583 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 584 </span>
<span class="FoldColumn">  </span><span class="lnr"> 585 </span>        sleep <span class="Identifier">$cmds_groups_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 586 </span>
<span class="FoldColumn">  </span><span class="lnr"> 587 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 588 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 589 </span>
<span class="FoldColumn">  </span><span class="lnr"> 590 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 591 </span>
<span class="FoldColumn">  </span><span class="lnr"> 592 </span><span class="Statement">proc</span> repeat_cmds {maxrounds pattern4cmd cmds cmds_intv cmd_timeout} {
<span class="FoldColumn">  </span><span class="lnr"> 593 </span>    myputs <span class="Constant">&quot;</span><span class="Identifier">$maxrounds</span><span class="Constant"> rounds of cmds will be executed&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 594 </span>    <span class="Statement">set</span> i <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 595 </span>    <span class="Statement">upvar</span> <span class="Identifier">$cmds</span> ref
<span class="FoldColumn">  </span><span class="lnr"> 596 </span>    <span class="Statement">while</span> {<span class="Identifier">$i</span>&lt;=<span class="Identifier">$maxrounds</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 597 </span>        do_cmds <span class="Identifier">$pattern4cmd</span> ref <span class="Identifier">$cmds_intv</span> <span class="Identifier">$cmd_timeout</span>
<span class="FoldColumn">  </span><span class="lnr"> 598 </span>        myputs <span class="Constant">&quot;</span><span class="Special">\n\n</span><span class="Constant">..#####################################..</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 599 </span>        myputs <span class="Constant">&quot;this is rounds </span><span class="Identifier">$i</span><span class="Constant"> of cmds set..</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 600 </span>        myputs <span class="Constant">&quot;..#####################################..</span><span class="Special">\n\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 601 </span>
<span class="FoldColumn">  </span><span class="lnr"> 602 </span><span class="Comment">        #this doesn't work</span>
<span class="FoldColumn">  </span><span class="lnr"> 603 </span><span class="Comment">#       trap {send_user &quot;bye&quot;; exit} SIGINT</span>
<span class="FoldColumn">  </span><span class="lnr"> 604 </span>        <span class="Statement">incr</span> i
<span class="FoldColumn">  </span><span class="lnr"> 605 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 606 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 607 </span>
<span class="FoldColumn">  </span><span class="lnr"> 608 </span><span class="Statement">proc</span> repeat_cmds_groups {maxrounds pattern4cmd                        <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr"> 609 </span>               CGS round_intv cmds_groups_intv                       <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr"> 610 </span>               cmds_intv cmd_timeout} {
<span class="FoldColumn">  </span><span class="lnr"> 611 </span>    myputs <span class="Constant">&quot;</span><span class="Identifier">$maxrounds</span><span class="Constant"> rounds of cmds groups will be executed&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 612 </span>    <span class="Statement">set</span> i <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 613 </span><span class="Comment">    #upvar $cmds ref</span>
<span class="FoldColumn">  </span><span class="lnr"> 614 </span>    <span class="Statement">while</span> {<span class="Identifier">$i</span>&lt;=<span class="Identifier">$maxrounds</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 615 </span>        do_cmds_groups <span class="Identifier">$pattern4cmd</span> <span class="Identifier">$CGS</span> <span class="Identifier">$cmds_groups_intv</span> <span class="Identifier">$cmds_intv</span> <span class="Identifier">$cmd_timeout</span>
<span class="FoldColumn">  </span><span class="lnr"> 616 </span>        myputs <span class="Constant">&quot;</span><span class="Special">\n\n</span><span class="Constant">....</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 617 </span>        myputs <span class="Constant">&quot;rounds </span><span class="Identifier">$i</span><span class="Constant">/</span><span class="Identifier">$maxrounds</span><span class="Constant">..will continue after </span><span class="Identifier">$round_intv</span><span class="Constant"> seconds...</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 618 </span>        myputs <span class="Constant">&quot;....</span><span class="Special">\n\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 619 </span>
<span class="FoldColumn">  </span><span class="lnr"> 620 </span><span class="Comment">        #wanted to stop the loop anytime,this doesn't work yet</span>
<span class="FoldColumn">  </span><span class="lnr"> 621 </span><span class="Comment">#       trap {send_user &quot;bye&quot;; exit} SIGINT</span>
<span class="FoldColumn">  </span><span class="lnr"> 622 </span>        <span class="Statement">incr</span> i
<span class="FoldColumn">  </span><span class="lnr"> 623 </span>        sleep <span class="Identifier">$round_intv</span>
<span class="FoldColumn">  </span><span class="lnr"> 624 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 625 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 626 </span>
<span class="FoldColumn">  </span><span class="lnr"> 627 </span><span class="Statement">proc</span> do_confirm {} {
<span class="FoldColumn">  </span><span class="lnr"> 628 </span>    myputs <span class="Constant">&quot;you sure you want to do that?(y/n)&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 629 </span>    stty raw
<span class="FoldColumn">  </span><span class="lnr"> 630 </span>    expect_user {
<span class="FoldColumn">  </span><span class="lnr"> 631 </span>        <span class="Constant">&quot;y&quot;</span> {<span class="Statement">return</span> <span class="Constant">1</span>}
<span class="FoldColumn">  </span><span class="lnr"> 632 </span>        <span class="Constant">&quot;n&quot;</span> {<span class="Statement">return</span> <span class="Constant">0</span>}
<span class="FoldColumn">  </span><span class="lnr"> 633 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 634 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 635 </span>
<span class="FoldColumn">  </span><span class="lnr"> 636 </span><span class="Statement">proc</span> do_sel {} {
<span class="FoldColumn">  </span><span class="lnr"> 637 </span>    myputs <span class="Constant">&quot;start sel data collections&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 638 </span><span class="Comment">#    if $NEWFEATURE {</span>
<span class="FoldColumn">  </span><span class="lnr"> 639 </span>    <span class="Statement">if</span> {[do_confirm]} {
<span class="FoldColumn">  </span><span class="lnr"> 640 </span>        send <span class="Constant">&quot;date</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 641 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 642 </span>        myputs <span class="Constant">&quot;sel data collections cancelled&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 643 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 644 </span><span class="Comment">#    }</span>
<span class="FoldColumn">  </span><span class="lnr"> 645 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 646 </span>
<span class="FoldColumn">  </span><span class="lnr"> 647 </span><span class="Statement">proc</span> do_showtech {} {
<span class="FoldColumn">  </span><span class="lnr"> 648 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 649 </span>
<span class="FoldColumn">  </span><span class="lnr"> 650 </span><span class="Statement">proc</span> diag_on_error {} {
<span class="FoldColumn">  </span><span class="lnr"> 651 </span>}
<span class="FoldColumn">  </span><span class="lnr"> 652 </span>
<span class="FoldColumn">  </span><span class="lnr"> 653 </span><span class="Comment">#interact mode,return control to user if all work done/failed</span>
<span class="FoldColumn">  </span><span class="lnr"> 654 </span><span class="Statement">proc</span> do_interact {code} {
<span class="FoldColumn">  </span><span class="lnr"> 655 </span>
<span class="FoldColumn">  </span><span class="lnr"> 656 </span>
<span class="FoldColumn">  </span><span class="lnr"> 657 </span><span class="Comment">    #hostname here is only needed when invoke script with local shell</span>
<span class="FoldColumn">  </span><span class="lnr"> 658 </span><span class="Comment">    #zip need to be global here, otherwise &quot;global&quot; in sendanemail won't</span>
<span class="FoldColumn">  </span><span class="lnr"> 659 </span><span class="Comment">    #take effect</span>
<span class="FoldColumn">  </span><span class="lnr"> 660 </span>    <span class="Statement">global</span> configfile hostname host initlog_file zip
<span class="FoldColumn">  </span><span class="lnr"> 661 </span>    <span class="Statement">global</span> CGS
<span class="FoldColumn">  </span><span class="lnr"> 662 </span>
<span class="FoldColumn">  </span><span class="lnr"> 663 </span><span class="Comment">    #global stuff real sucks, I know, but just for simplicity for now..</span>
<span class="FoldColumn">  </span><span class="lnr"> 664 </span><span class="Comment">    #global NEWFEATURE DEBUG CGS caseid_pattern</span>
<span class="FoldColumn">  </span><span class="lnr"> 665 </span><span class="Comment">    #global mylog_file configfile redosource hostname pa_intv caselog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 666 </span><span class="Comment">    #global pattern4cmd precmds cmds cmds_intv cmd_timeout maxrounds</span>
<span class="FoldColumn">  </span><span class="lnr"> 667 </span>
<span class="FoldColumn">  </span><span class="lnr"> 668 </span><span class="Comment">    #most cases re-&quot;source&quot; config file reduces global vars</span>
<span class="FoldColumn">  </span><span class="lnr"> 669 </span><span class="Comment">    #but it won't garentee all vars in configfile be updated correctly</span>
<span class="FoldColumn">  </span><span class="lnr"> 670 </span><span class="Comment">    #example: in config file:</span>
<span class="FoldColumn">  </span><span class="lnr"> 671 </span><span class="Comment">    #1)set ospf(0) abc;set ospf(1) 123</span>
<span class="FoldColumn">  </span><span class="lnr"> 672 </span><span class="Comment">    #change ospf(0) to def, and delete ospf(1) in config file,</span>
<span class="FoldColumn">  </span><span class="lnr"> 673 </span><span class="Comment">    #now re-&quot;source&quot; here only update ospf(0), but won't delete ospf(1) as expected</span>
<span class="FoldColumn">  </span><span class="lnr"> 674 </span>    <span class="Statement">source</span> <span class="Identifier">$configfile</span>
<span class="FoldColumn">  </span><span class="lnr"> 675 </span>    <span class="Statement">set</span> n <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr"> 676 </span>
<span class="FoldColumn">  </span><span class="lnr"> 677 </span><span class="Comment">#    code:</span>
<span class="FoldColumn">  </span><span class="lnr"> 678 </span><span class="Comment">#    enter from point0: spawn a local shell</span>
<span class="FoldColumn">  </span><span class="lnr"> 679 </span><span class="Comment">#    enter from point1: autologin fail and force into</span>
<span class="FoldColumn">  </span><span class="lnr"> 680 </span><span class="Comment">#    enter from point2: autologin fail, user confirm to</span>
<span class="FoldColumn">  </span><span class="lnr"> 681 </span><span class="Comment">#    enter from point3: login ok,and before batch cmds</span>
<span class="FoldColumn">  </span><span class="lnr"> 682 </span><span class="Comment">#    enter from point4: all done</span>
<span class="FoldColumn">  </span><span class="lnr"> 683 </span><span class="Comment">#    enter from point5: no autologin</span>
<span class="FoldColumn">  </span><span class="lnr"> 684 </span><span class="Comment">#</span>
<span class="FoldColumn">  </span><span class="lnr"> 685 </span>
<span class="FoldColumn">  </span><span class="lnr"> 686 </span>    <span class="Statement">switch</span> -- <span class="Identifier">$code</span> <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr"> 687 </span>    <span class="Constant">0</span> {
<span class="FoldColumn">  </span><span class="lnr"> 688 </span>        <span class="Statement">set</span> reason <span class="Constant">&quot;spawn a local shell&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 689 </span>    } <span class="Constant">1</span> {
<span class="FoldColumn">  </span><span class="lnr"> 690 </span>        <span class="Statement">set</span> reason <span class="Constant">&quot;autologin failed,force flag set to go interact&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 691 </span>    } <span class="Constant">2</span> {
<span class="FoldColumn">  </span><span class="lnr"> 692 </span>        <span class="Statement">set</span> reason <span class="Constant">&quot;autologin failed,user confirmed to go&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 693 </span>    } <span class="Constant">3</span> {
<span class="FoldColumn">  </span><span class="lnr"> 694 </span>        <span class="Statement">set</span> reason <span class="Constant">&quot;autologin succeed,flag set to go interact&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 695 </span>    } <span class="Constant">4</span> {
<span class="FoldColumn">  </span><span class="lnr"> 696 </span>        <span class="Statement">set</span> reason <span class="Constant">&quot;all work done, flag set to go interact&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 697 </span>    } <span class="Constant">5</span> {
<span class="FoldColumn">  </span><span class="lnr"> 698 </span>        <span class="Statement">set</span> reason <span class="Constant">&quot;no autologin flag set to go interact&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 699 </span>    }
<span class="FoldColumn">  </span><span class="lnr"> 700 </span>
<span class="FoldColumn">  </span><span class="lnr"> 701 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;go to interact mode on reason:</span><span class="Identifier">$reason</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 702 </span>    <span class="Statement">if</span> <span class="Identifier">$welcome_msg</span> {
<span class="FoldColumn">  </span><span class="lnr"> 703 </span>    myputs <span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 704 </span><span class="Constant">    welcome to mylogin shell! it's an clone(spawn) of bash plus some new customized shortcut commands</span>
<span class="FoldColumn">  </span><span class="lnr"> 705 </span><span class="Constant">    the intention is to help JTAC day-to-day work. But it can also be used for ANY other usual tasks </span>
<span class="FoldColumn">  </span><span class="lnr"> 706 </span><span class="Constant">    wherever the origin shell(e.g bash) was used, plus now we have logging, anti-timeout, and other features.</span>
<span class="FoldColumn">  </span><span class="lnr"> 707 </span><span class="Constant">    type !i for currently available cmds, !h for most frequently used cmds, and !T for a mini tutorial</span>
<span class="FoldColumn">  </span><span class="lnr"> 708 </span><span class="Constant">    enjoy it!</span>
<span class="FoldColumn">  </span><span class="lnr"> 709 </span>
<span class="FoldColumn">  </span><span class="lnr"> 710 </span>                                                              -v0<span class="Constant">.2</span>     ping@juniper.net<span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 711 </span><span class="Constant">    }</span>
<span class="FoldColumn">  </span><span class="lnr"> 712 </span>
<span class="FoldColumn">  </span><span class="lnr"> 713 </span><span class="Comment">    #start currlog_file value from initlog_file, which, was acquired in the very beginning</span>
<span class="FoldColumn">  </span><span class="lnr"> 714 </span><span class="Comment">    #moment of the config file reading when the script was just running</span>
<span class="FoldColumn">  </span><span class="lnr"> 715 </span><span class="Comment">    #this is to avoid the dynamic nature of the config file, especially the timebased file naming</span>
<span class="FoldColumn">  </span><span class="lnr"> 716 </span><span class="Comment">    #so source config file again won't change currlog_file anymore</span>
<span class="FoldColumn">  </span><span class="lnr"> 717 </span>    <span class="Statement">set</span> currlog_file <span class="Identifier">$initlog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 718 </span>
<span class="FoldColumn">  </span><span class="lnr"> 719 </span>    <span class="Statement">set</span> log_started <span class="Identifier">$log_when_start</span>
<span class="FoldColumn">  </span><span class="lnr"> 720 </span>
<span class="FoldColumn">  </span><span class="lnr"> 721 </span><span class="Comment">    #initially newcaseid is same as caseid in config file, but it will change per user cmds</span>
<span class="FoldColumn">  </span><span class="lnr"> 722 </span>    <span class="Statement">set</span> newcaseid <span class="Identifier">$caseid</span>
<span class="FoldColumn">  </span><span class="lnr"> 723 </span><span class="Comment">    #initial caseid and caselog were preserved for some use:mostly to generate full name </span>
<span class="FoldColumn">  </span><span class="lnr"> 724 </span><span class="Comment">    #of a new log file by replacing initcaseid with a new caseid, based on </span>
<span class="FoldColumn">  </span><span class="lnr"> 725 </span><span class="Comment">    #full name of the initial caselog file</span>
<span class="FoldColumn">  </span><span class="lnr"> 726 </span>    <span class="Statement">set</span> initcaseid <span class="Identifier">$caseid</span>
<span class="FoldColumn">  </span><span class="lnr"> 727 </span>    <span class="Statement">set</span> initcaselog_file <span class="Identifier">$caselog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 728 </span>
<span class="FoldColumn">  </span><span class="lnr"> 729 </span>    <span class="Statement">set</span> newdmpfilebasename <span class="Identifier">$dmpfilebasename</span>
<span class="FoldColumn">  </span><span class="lnr"> 730 </span>
<span class="FoldColumn">  </span><span class="lnr"> 731 </span>    stty -raw
<span class="FoldColumn">  </span><span class="lnr"> 732 </span>    interact {
<span class="FoldColumn">  </span><span class="lnr"> 733 </span><span class="Comment">        #wait for match from user, if timeout then send a blank then delete it</span>
<span class="FoldColumn">  </span><span class="lnr"> 734 </span><span class="Comment">        #this bring an anti-idle feature</span>
<span class="FoldColumn">  </span><span class="lnr"> 735 </span>        timeout <span class="Identifier">$anti_idle_timeout</span> {
<span class="FoldColumn">  </span><span class="lnr"> 736 </span>            send <span class="Identifier">$anti_idle_string</span>
<span class="FoldColumn">  </span><span class="lnr"> 737 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 738 </span><span class="Comment">        #</span>
<span class="FoldColumn">  </span><span class="lnr"> 739 </span><span class="Comment">        #under interact mode, use some keystroke cmds to instruct</span>
<span class="FoldColumn">  </span><span class="lnr"> 740 </span><span class="Comment">        #script to do some other automations</span>
<span class="FoldColumn">  </span><span class="lnr"> 741 </span><span class="Comment">        #-echo make keystokes matching listed patterns also display</span>
<span class="FoldColumn">  </span><span class="lnr"> 742 </span><span class="Comment">        #side effect is duplicate display if partial pattern were being inputted</span>
<span class="FoldColumn">  </span><span class="lnr"> 743 </span><span class="Comment">        #use ! to make these patterns unlikely to be accidently duplicated with other cmds for spawned app</span>
<span class="FoldColumn">  </span><span class="lnr"> 744 </span>
<span class="FoldColumn">  </span><span class="lnr"> 745 </span>        -echo -re <span class="Constant">&quot;!i&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 746 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">available cmds under interact mode:&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 747 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 748 </span><span class="Constant">        EXCUTIONS:                                      ATTACHING (logs/coredump decode):                               </span>
<span class="FoldColumn">  </span><span class="lnr"> 749 </span><span class="Constant">            --execute precmds--                                         !alx(x:m/c/b)   (a)ttach curr (l)og:</span><span class="Identifier">$currlog_file</span><span class="Constant"> </span>
<span class="FoldColumn">  </span><span class="lnr"> 750 </span><span class="Constant">               !eP     (e)xcute actions in '(p)rework'                     with caseid </span><span class="Identifier">$caseid</span><span class="Constant"> (via email)</span>
<span class="FoldColumn">  </span><span class="lnr"> 751 </span><span class="Constant">               pattern-action-list                                     !alm    email to me(</span><span class="Identifier">$emailme</span><span class="Constant">) only</span>
<span class="FoldColumn">  </span><span class="lnr"> 752 </span><span class="Constant">            !ep         (e)xecute cmds in (p)recmds list                !alc    email to case(</span><span class="Identifier">$emailcase</span><span class="Constant">) only</span>
<span class="FoldColumn">  </span><span class="lnr"> 753 </span><span class="Constant">               (term len/width/etc)                                    !alb    email to both </span><span class="Identifier">$emailme</span><span class="Constant"> and </span><span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr"> 754 </span><span class="Constant">                                                                !alt a@b email to a@b.com, t.b.c</span>
<span class="FoldColumn">  </span><span class="lnr"> 755 </span><span class="Constant">            --execute/repeat(and email logs of) commands--              !adx    (A)ttach decoded coredump </span>
<span class="FoldColumn">  </span><span class="lnr"> 756 </span><span class="Constant">            --in 'cmds','CGS'--                                             files under /mnt/coredumps/</span><span class="Identifier">$caseid</span><span class="Constant"> (via email)</span>
<span class="FoldColumn">  </span><span class="lnr"> 757 </span><span class="Constant">            !ec         (e)xecute whatever in '(c)mds'                                                                      </span>
<span class="FoldColumn">  </span><span class="lnr"> 758 </span><span class="Constant">            !eCx (x:m/c/b) same,also e(m)ail logs                  ABBREVIATIONS:</span>
<span class="FoldColumn">  </span><span class="lnr"> 759 </span><span class="Constant">               with caseid </span><span class="Identifier">$caseid</span><span class="Constant">                                     !b&lt;KEY&gt;. send the corresponding long </span>
<span class="FoldColumn">  </span><span class="lnr"> 760 </span><span class="Constant">            !rc          same,but (r)epeatedly                           cmd strings based on the key defined in </span>
<span class="FoldColumn">  </span><span class="lnr"> 761 </span><span class="Constant">            !eg          (e)xecute whatever in 'CGS',recursively        ABB(KEY) array</span>
<span class="FoldColumn">  </span><span class="lnr"> 762 </span><span class="Constant">            !rg          same, but repeatedly                                                                               </span>
<span class="FoldColumn">  </span><span class="lnr"> 763 </span><span class="Constant">                                                             LOGGINGS:</span>
<span class="FoldColumn">  </span><span class="lnr"> 764 </span><span class="Constant">            --execute/repeat(and email logs of) cmds in--               !lf     change (l)og file based on </span>
<span class="FoldColumn">  </span><span class="lnr"> 765 </span><span class="Constant">            ---'pattern-action-list','PAGS'--                               caseid specified in config (f)ile:</span><span class="Identifier">$caselog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 766 </span><span class="Constant">            !ea         (e)xecute 'pattern_action_list'                 !lc CASEID ..based on (c)aseid ,</span>
<span class="FoldColumn">  </span><span class="lnr"> 767 </span><span class="Constant">            !eAx (x:m/c/b) same, plus emails                                e,g: 1111-1111-1111.log</span>
<span class="FoldColumn">  </span><span class="lnr"> 768 </span><span class="Constant">            !eG         (e)xecute PAGS,recursive                        !lC CASEID ..based on (c)aseid plus </span>
<span class="FoldColumn">  </span><span class="lnr"> 769 </span><span class="Constant">            !ra&lt;CR&gt;     same as !ea, (r)epeat </span><span class="Identifier">$maxrounds</span><span class="Constant">                    host name </span><span class="Identifier">$caseid</span><span class="Constant">-</span><span class="Identifier">$host</span><span class="Constant">.log</span>
<span class="FoldColumn">  </span><span class="lnr"> 770 </span><span class="Constant">            !ra N&lt;CR&gt;   same, N rounds                                  !li     stop current (l)og, </span>
<span class="FoldColumn">  </span><span class="lnr"> 771 </span><span class="Constant">            !rG&lt;CR&gt;     (r)epeat PAGS for </span><span class="Identifier">$maxrounds</span><span class="Constant">                        return to (i)nitial log:</span><span class="Identifier">$initlog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 772 </span><span class="Constant">            !rG N       (r)epeat PAGS for N rounds                      !la NAME&lt;CR&gt; change (l)og file to an </span>
<span class="FoldColumn">  </span><span class="lnr"> 773 </span><span class="Constant">                                                                    (a)rbitrary name (!la mylog&lt;CR&gt;) under </span><span class="Identifier">$log_dir</span>
<span class="FoldColumn">  </span><span class="lnr"> 774 </span><span class="Constant">            --execute or execute recursively cmds in                    !lA FULLPATH&lt;CR&gt; change (l)og file to another </span>
<span class="FoldColumn">  </span><span class="lnr"> 775 </span><span class="Constant">            --user-defined cmd groups or PA groups--                        full path name logfile:!lA /a/b/c.txt</span>
<span class="FoldColumn">  </span><span class="lnr"> 776 </span><span class="Constant">            !mlx(x:c/p/s) (l)list currently a/v groups                  !ls     (s)top (l)og recording on </span>
<span class="FoldColumn">  </span><span class="lnr"> 777 </span><span class="Constant">               (cmd,pa,pa group for SHELL),from CGL,PAGL                   current logfile:</span><span class="Identifier">$currlog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 778 </span><span class="Constant">            !mg CMD_GROUP&lt;CR&gt; (e)xecute one cmd grp,no recursive        !lr     same, resume it</span>
<span class="FoldColumn">  </span><span class="lnr"> 779 </span><span class="Constant">            !mG PA_GROUP&lt;CR&gt; (e)xecute 1 PA group,recursively           !lS     (S)how current (l)ogfile </span>
<span class="FoldColumn">  </span><span class="lnr"> 780 </span><span class="Constant">            !mS PA_GROUP&lt;CR&gt; same,as host SHELL,recursively                 name:</span><span class="Identifier">$currlog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 781 </span>
<span class="FoldColumn">  </span><span class="lnr"> 782 </span>            !Hl         (h)ost (l)ist                              MISC:
<span class="FoldColumn">  </span><span class="lnr"> 783 </span>                                                               !h      this (h)elp
<span class="FoldColumn">  </span><span class="lnr"> 784 </span>            --execute/email coredump--                                  !dd     (d)efine a new (d)mp <span class="Statement">file</span>
<span class="FoldColumn">  </span><span class="lnr"> 785 </span>            !ed         (e)xecute core(d)ump analysis                       name:<span class="Identifier">$dmpfilebasename</span>,obsolete
<span class="FoldColumn">  </span><span class="lnr"> 786 </span>            !eDx (x:m/c/b) same, plus sending emails                    !da     <span class="Statement">set</span> arbitary values,
<span class="FoldColumn">  </span><span class="lnr"> 787 </span>               not generalized yet, only a/v in <span class="Statement">my</span> PC                      (<span class="Statement">set</span> caseid <span class="Constant">2222</span>-<span class="Constant">2222</span>-<span class="Constant">2222</span>),obsolete
<span class="FoldColumn">  </span><span class="lnr"> 788 </span>                                                                !T  a mini tutorial
<span class="FoldColumn">  </span><span class="lnr"> 789 </span>                                                                !h  a <span class="Statement">list</span> of most frequently used commands
<span class="FoldColumn">  </span><span class="lnr"> 790 </span>
<span class="FoldColumn">  </span><span class="lnr"> 791 </span>            --not finished features--
<span class="FoldColumn">  </span><span class="lnr"> 792 </span>            !t HOSTNAME&lt;CR&gt; !s HOSTNAME&lt;CR&gt;:  telnet/ssh login to HOSTNAME, which will be resolved to HOST(IP addres)
<span class="FoldColumn">  </span><span class="lnr"> 793 </span>                the intention here is to remove dependency on /etc/hosts, which is not changable without root priv.
<span class="FoldColumn">  </span><span class="lnr"> 794 </span>        ver <span class="Constant">0.2</span>
<span class="FoldColumn">  </span><span class="lnr"> 795 </span>    <span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 796 </span><span class="Constant">        }</span>
<span class="FoldColumn">  </span><span class="lnr"> 797 </span>
<span class="FoldColumn">  </span><span class="lnr"> 798 </span>        -echo -re <span class="Constant">&quot;!h&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 799 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">frequently used cmds under interact mode:&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 800 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 801 </span><span class="Constant">            --frequently used cmds--</span>
<span class="FoldColumn">  </span><span class="lnr"> 802 </span><span class="Constant">            !lc CASEID (=&gt;log name: </span><span class="Identifier">$caseid</span><span class="Constant">.log) or         !da set host xo&lt;CR&gt;  !lC 1111-1111-1111(=&gt;log name: </span><span class="Identifier">$caseid$host</span><span class="Constant">.log)</span>
<span class="FoldColumn">  </span><span class="lnr"> 803 </span><span class="Constant">            !ls !lr (s)top/(r)esume (l)og recording on current logfile:</span><span class="Identifier">$currlog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 804 </span><span class="Constant">            !mS pre&lt;CR&gt; or !ep then !eg or !eCb (=&gt;exec CLIes)  !eDm (=&gt; execute dmp decode, currently only a/v on my own pc)</span>
<span class="FoldColumn">  </span><span class="lnr"> 805 </span><span class="Constant">            !mS scott_check&lt;CR&gt; (=&gt;run scott script)      !mS cpucheck&lt;CR&gt; (=&gt;run KA34030 high CPU check)</span>
<span class="FoldColumn">  </span><span class="lnr"> 806 </span><span class="Constant">            </span>
<span class="FoldColumn">  </span><span class="lnr"> 807 </span><span class="Constant">            type !T for a mini tutorial</span>
<span class="FoldColumn">  </span><span class="lnr"> 808 </span><span class="Constant">            type !i for more info/cmds</span>
<span class="FoldColumn">  </span><span class="lnr"> 809 </span><span class="Constant">            ver 0.2</span>
<span class="FoldColumn">  </span><span class="lnr"> 810 </span><span class="Constant">    &quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 811 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 812 </span>
<span class="FoldColumn">  </span><span class="lnr"> 813 </span>        -echo -re <span class="Constant">&quot;!T&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 814 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">a quick tutorial for most frequently used commdands:&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 815 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 816 </span><span class="Constant">            :by default, once started, everything will be logged in a file under </span><span class="Special">\$</span><span class="Constant">log_dir(current:</span><span class="Identifier">$log_dir</span><span class="Constant">), </span>
<span class="FoldColumn">  </span><span class="lnr"> 817 </span><span class="Constant">            :in a filename defined in </span><span class="Special">\$</span><span class="Constant">mylogfile (current:</span><span class="Identifier">$mylog_file</span><span class="Constant">), to change the log file name</span>
<span class="FoldColumn">  </span><span class="lnr"> 818 </span><span class="Constant">            :to current case number, type following command. </span>
<span class="FoldColumn">  </span><span class="lnr"> 819 </span>
<span class="FoldColumn">  </span><span class="lnr"> 820 </span>            :this will change the logfile to a <span class="Statement">filename</span> defined in \<span class="Identifier">$caselog_file</span> (current:<span class="Identifier">$caselog_file</span>)
<span class="FoldColumn">  </span><span class="lnr"> 821 </span>            :under a folder \<span class="Identifier">$caselog_dir</span> (current:<span class="Identifier">$caselog_dir</span>) these VARs are define in <span class="Statement">file</span>:~/.mylogin/coredump.conf
<span class="FoldColumn">  </span><span class="lnr"> 822 </span>            !lc <span class="Constant">2011</span>-<span class="Constant">0511</span>-<span class="Constant">0012</span>
<span class="FoldColumn">  </span><span class="lnr"> 823 </span>
<span class="FoldColumn">  </span><span class="lnr"> 824 </span>            :this is normal telnet(ssh) command to login remote system
<span class="FoldColumn">  </span><span class="lnr"> 825 </span>            telnet <span class="Constant">1.1.1.1</span>
<span class="FoldColumn">  </span><span class="lnr"> 826 </span>            ...//..username,password,jumpstations,token,etc..//...
<span class="FoldColumn">  </span><span class="lnr"> 827 </span>            :assume we are now in privilidge mode of E320
<span class="FoldColumn">  </span><span class="lnr"> 828 </span>            ABC-VFTTP-<span class="Constant">120</span>#
<span class="FoldColumn">  </span><span class="lnr"> 829 </span>
<span class="FoldColumn">  </span><span class="lnr"> 830 </span>            :type following, <span class="Statement">then</span> hit enter (&lt;CR&gt;), this will adjust the term width/len/acquire a shell session and <span class="Statement">exit</span>
<span class="FoldColumn">  </span><span class="lnr"> 831 </span>            !mS pre
<span class="FoldColumn">  </span><span class="lnr"> 832 </span>            :type following, no need enter, this will start some frequently used CLIes (not vxShell), defined under ~/.mylogin/cmds-data.conf
<span class="FoldColumn">  </span><span class="lnr"> 833 </span>            :it will also send an email <span class="Statement">after</span> it finished (<span class="Statement">read</span> below)
<span class="FoldColumn">  </span><span class="lnr"> 834 </span>            !eg
<span class="FoldColumn">  </span><span class="lnr"> 835 </span>
<span class="FoldColumn">  </span><span class="lnr"> 836 </span>            :wait until it finished, type following to send another email anytime you want the logs,
<span class="FoldColumn">  </span><span class="lnr"> 837 </span>            :to whoever defined in \<span class="Identifier">$emailme</span>(currently is <span class="Identifier">$emailme</span>), <span class="Identifier">$emailcase</span> (currently <span class="Identifier">$emailcase</span>) in <span class="Statement">file</span> ~/.mylogin/mylogin.conf
<span class="FoldColumn">  </span><span class="lnr"> 838 </span>            :this is convenient to (a)ttach (l)og to (me), to (c)ase, or to (b)oth
<span class="FoldColumn">  </span><span class="lnr"> 839 </span>            !alm   (or !alc)   (or !alb)
<span class="FoldColumn">  </span><span class="lnr"> 840 </span>
<span class="FoldColumn">  </span><span class="lnr"> 841 </span>            :sometimes its unavoidable to run some script, !mS &lt;SCRIPT&gt; is the command, SCRIPT need to be defined in a <span class="Statement">file</span> under ~/.mylogin/
<span class="FoldColumn">  </span><span class="lnr"> 842 </span>            :here is an example to run scott's data-collection CLIes and attach the log in an email,
<span class="FoldColumn">  </span><span class="lnr"> 843 </span>            :the SCRIPT <span class="Statement">file</span> was ~/.mylogin/scott_check.conf, you can check that <span class="Statement">file</span> and
<span class="FoldColumn">  </span><span class="lnr"> 844 </span>            :just follow its simply syntax you can define your own new script <span class="Statement">file</span>,
<span class="FoldColumn">  </span><span class="lnr"> 845 </span>            :type following and hit enter
<span class="FoldColumn">  </span><span class="lnr"> 846 </span>            !mS scott_check
<span class="FoldColumn">  </span><span class="lnr"> 847 </span>
<span class="FoldColumn">  </span><span class="lnr"> 848 </span>            :there are some other misc commands/features available, in some cases they are useful
<span class="FoldColumn">  </span><span class="lnr"> 849 </span>            :to stop the logging
<span class="FoldColumn">  </span><span class="lnr"> 850 </span>            !ls
<span class="FoldColumn">  </span><span class="lnr"> 851 </span>            :to resume
<span class="FoldColumn">  </span><span class="lnr"> 852 </span>            !lr
<span class="FoldColumn">  </span><span class="lnr"> 853 </span>
<span class="FoldColumn">  </span><span class="lnr"> 854 </span>            type !h <span class="Statement">for</span> a brief <span class="Statement">list</span> of most frequently used commands
<span class="FoldColumn">  </span><span class="lnr"> 855 </span>            type !i <span class="Statement">for</span> more <span class="Statement">info</span>/cmds
<span class="FoldColumn">  </span><span class="lnr"> 856 </span>            <span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 857 </span><span class="Constant">        }</span>
<span class="FoldColumn">  </span><span class="lnr"> 858 </span>
<span class="FoldColumn">  </span><span class="lnr"> 859 </span><span class="Comment">        #log stop</span>
<span class="FoldColumn">  </span><span class="lnr"> 860 </span>        -echo <span class="Constant">&quot;!ls&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 861 </span>            <span class="Statement">if</span> <span class="Identifier">$log_started</span> {
<span class="FoldColumn">  </span><span class="lnr"> 862 </span>               myputs <span class="Constant">&quot;stopped log recording on file </span><span class="Identifier">$currlog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 863 </span>               log_file
<span class="FoldColumn">  </span><span class="lnr"> 864 </span>               <span class="Statement">set</span> log_started <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr"> 865 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 866 </span>               myputs <span class="Constant">&quot;nothing to stop, log not started yet&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 867 </span>            }
<span class="FoldColumn">  </span><span class="lnr"> 868 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 869 </span>
<span class="FoldColumn">  </span><span class="lnr"> 870 </span><span class="Comment">        #log show</span>
<span class="FoldColumn">  </span><span class="lnr"> 871 </span>        -echo <span class="Constant">&quot;!lS&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 872 </span>            <span class="Statement">if</span> <span class="Identifier">$log_started</span> {
<span class="FoldColumn">  </span><span class="lnr"> 873 </span>               myputs <span class="Constant">&quot;current log file:</span><span class="Identifier">$currlog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 874 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 875 </span>               myputs <span class="Constant">&quot;currently no log has been started yet&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 876 </span>            }
<span class="FoldColumn">  </span><span class="lnr"> 877 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 878 </span>
<span class="FoldColumn">  </span><span class="lnr"> 879 </span><span class="Comment">        #log view, not done yet</span>
<span class="FoldColumn">  </span><span class="lnr"> 880 </span>        -echo <span class="Constant">&quot;!lv&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 881 </span>            <span class="Statement">if</span> <span class="Identifier">$log_started</span> {
<span class="FoldColumn">  </span><span class="lnr"> 882 </span>               myputs <span class="Constant">&quot;viewing current log file:</span><span class="Identifier">$currlog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 883 </span>               myexec <span class="Constant">&quot;less </span>[<span class="Statement">glob</span> <span class="Identifier">$currlog_file</span>]<span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 884 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 885 </span>               myputs <span class="Constant">&quot;currently no log has been started yet&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 886 </span>            }
<span class="FoldColumn">  </span><span class="lnr"> 887 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 888 </span>
<span class="FoldColumn">  </span><span class="lnr"> 889 </span><span class="Comment">        #log resume/start</span>
<span class="FoldColumn">  </span><span class="lnr"> 890 </span>        -echo <span class="Constant">&quot;!lr&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 891 </span><span class="Comment">            #expect:need to stop first in order to &quot;resume&quot; it</span>
<span class="FoldColumn">  </span><span class="lnr"> 892 </span>            log_file
<span class="FoldColumn">  </span><span class="lnr"> 893 </span>            log_file <span class="Identifier">$currlog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 894 </span>            myputs <span class="Constant">&quot;resume log recording to file </span><span class="Identifier">$currlog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 895 </span>            <span class="Statement">set</span> log_started <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 896 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 897 </span>
<span class="FoldColumn">  </span><span class="lnr"> 898 </span><span class="Comment">        #log change per config file</span>
<span class="FoldColumn">  </span><span class="lnr"> 899 </span>        -echo <span class="Constant">&quot;!lf&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 900 </span><span class="Comment">            #get new caselog_file name from config(which is based on caseid)</span>
<span class="FoldColumn">  </span><span class="lnr"> 901 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr"> 902 </span><span class="Comment">            #expect:need to stop first in order to &quot;resume&quot; it</span>
<span class="FoldColumn">  </span><span class="lnr"> 903 </span>            log_file
<span class="FoldColumn">  </span><span class="lnr"> 904 </span>            log_file <span class="Identifier">$caselog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 905 </span>            <span class="Statement">set</span> currlog_file <span class="Identifier">$caselog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 906 </span>            myputs <span class="Constant">&quot;resume log recording to file </span><span class="Identifier">$currlog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 907 </span>            <span class="Statement">set</span> log_started <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 908 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 909 </span>
<span class="FoldColumn">  </span><span class="lnr"> 910 </span><span class="Comment">        #log return to initial file</span>
<span class="FoldColumn">  </span><span class="lnr"> 911 </span>        -echo <span class="Constant">&quot;!li&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 912 </span><span class="Comment">            #get new caselog_file name from config(which is based on caseid)</span>
<span class="FoldColumn">  </span><span class="lnr"> 913 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr"> 914 </span><span class="Comment">            #expect:need to stop first in order to &quot;resume&quot; it</span>
<span class="FoldColumn">  </span><span class="lnr"> 915 </span>            log_file
<span class="FoldColumn">  </span><span class="lnr"> 916 </span>            log_file <span class="Identifier">$initlog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 917 </span>            myputs <span class="Constant">&quot;stop log on </span><span class="Identifier">$currlog_file</span><span class="Constant">, resume on initial log file </span><span class="Identifier">$initlog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 918 </span>            <span class="Statement">set</span> currlog_file <span class="Identifier">$initlog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 919 </span>            <span class="Statement">set</span> log_started <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 920 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 921 </span>
<span class="FoldColumn">  </span><span class="lnr"> 922 </span><span class="Comment">        #log change to caseid</span>
<span class="FoldColumn">  </span><span class="lnr"> 923 </span>        -echo -re <span class="Constant">&quot;!lc </span><span class="Identifier">$caseid_pattern</span><span class="Constant">|!lC </span><span class="Identifier">$caseid_pattern</span><span class="Constant">&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 924 </span><span class="Comment">            #if $redosource {source $configfile}</span>
<span class="FoldColumn">  </span><span class="lnr"> 925 </span><span class="Comment">            #get user input</span>
<span class="FoldColumn">  </span><span class="lnr"> 926 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr"> 927 </span><span class="Comment">            #scan the input and find what followed &quot;!l &quot; and use it as newcaseid</span>
<span class="FoldColumn">  </span><span class="lnr"> 928 </span>            <span class="Statement">if</span> {[<span class="Statement">regexp</span> {^(!l.) (.*)} <span class="Identifier">$a</span> -&gt; cmd_pref newcaseid] eq <span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 929 </span><span class="Comment">            #if {[scan $a &quot;!lc %s&quot; newcaseid] eq 1} </span>
<span class="FoldColumn">  </span><span class="lnr"> 930 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get new caseid </span><span class="Identifier">$newcaseid</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 931 </span><span class="Comment">               #stop old log and start on the new file name</span>
<span class="FoldColumn">  </span><span class="lnr"> 932 </span>               log_file
<span class="FoldColumn">  </span><span class="lnr"> 933 </span>                <span class="Statement">if</span> {<span class="Identifier">$cmd_pref</span> == <span class="Constant">&quot;!lc&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 934 </span><span class="Comment">                   #replace caseid in the caselog_file full name and get new caselogfile name</span>
<span class="FoldColumn">  </span><span class="lnr"> 935 </span>                   <span class="Statement">set</span> newcaselog_file [<span class="Statement">string</span> map [<span class="Statement">list</span> <span class="Identifier">$caseid</span> <span class="Identifier">$newcaseid</span>] <span class="Identifier">$caselog_file</span>]
<span class="FoldColumn">  </span><span class="lnr"> 936 </span>               } <span class="Statement">elseif</span> {<span class="Identifier">$cmd_pref</span> == <span class="Constant">&quot;!lC&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 937 </span>                   <span class="Statement">set</span> newcaselog_file [<span class="Statement">string</span> map [<span class="Statement">list</span> <span class="Identifier">$caseid</span> <span class="Constant">&quot;</span><span class="Identifier">$newcaseid</span><span class="Constant">-</span><span class="Identifier">$host</span><span class="Constant">&quot;</span>] <span class="Identifier">$caselog_file</span>]
<span class="FoldColumn">  </span><span class="lnr"> 938 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 939 </span><span class="Comment">                   #place holder</span>
<span class="FoldColumn">  </span><span class="lnr"> 940 </span>               }
<span class="FoldColumn">  </span><span class="lnr"> 941 </span>               log_file <span class="Identifier">$newcaselog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 942 </span>               myputs <span class="Constant">&quot;stop logging on:</span><span class="Identifier">$currlog_file</span><span class="Constant">,continue on:</span><span class="Identifier">$newcaselog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 943 </span>               <span class="Statement">set</span> currlog_file <span class="Identifier">$newcaselog_file</span>
<span class="FoldColumn">  </span><span class="lnr"> 944 </span><span class="Comment">               #because other cmd also my do re-source beforehand, following may not work</span>
<span class="FoldColumn">  </span><span class="lnr"> 945 </span><span class="Comment">               #myputs &quot;use newcaseid:$newcaseid instead of old caseid:$caseid&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 946 </span><span class="Comment">               #set caseid newcaseid</span>
<span class="FoldColumn">  </span><span class="lnr"> 947 </span>               <span class="Statement">set</span> log_started <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr"> 948 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 949 </span>               myputs <span class="Constant">&quot;nothing found in inputted string&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 950 </span>            }
<span class="FoldColumn">  </span><span class="lnr"> 951 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 952 </span>
<span class="FoldColumn">  </span><span class="lnr"> 953 </span>
<span class="FoldColumn">  </span><span class="lnr"> 954 </span><span class="Comment">        #dummy codes, for test purpose only</span>
<span class="FoldColumn">  </span><span class="lnr"> 955 </span>        -echo -re <span class="Constant">&quot;!zl.&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 956 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr"> 957 </span>            <span class="Statement">if</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!zl1&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 958 </span>               myputs <span class="Constant">&quot;tests:ch followed !zl is 1&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 959 </span>            } <span class="Statement">elseif</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!zl2&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 960 </span>               myputs <span class="Constant">&quot;tests:ch followed !zl is 2&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 961 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 962 </span>               myputs <span class="Constant">&quot;tests:ch followed !zl is not 1 or 2&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 963 </span>            }
<span class="FoldColumn">  </span><span class="lnr"> 964 </span>        }
<span class="FoldColumn">  </span><span class="lnr"> 965 </span>
<span class="FoldColumn">  </span><span class="lnr"> 966 </span><span class="Comment">        #log attach</span>
<span class="FoldColumn">  </span><span class="lnr"> 967 </span>        -echo -re <span class="Constant">&quot;!al.&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 968 </span><span class="Comment">            #get new caselog_file name from config(which is based on caseid)</span>
<span class="FoldColumn">  </span><span class="lnr"> 969 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr"> 970 </span><span class="Comment">            #update the caseid,if ever changed (via !lc)</span>
<span class="FoldColumn">  </span><span class="lnr"> 971 </span>            <span class="Statement">set</span> caseid <span class="Identifier">$newcaseid</span>
<span class="FoldColumn">  </span><span class="lnr"> 972 </span>
<span class="FoldColumn">  </span><span class="lnr"> 973 </span>
<span class="FoldColumn">  </span><span class="lnr"> 974 </span><span class="Comment">#           if $DEBUG {myputs &quot;value of zip is $zip&quot;}</span>
<span class="FoldColumn">  </span><span class="lnr"> 975 </span>            <span class="Statement">if</span> <span class="Identifier">$log_started</span> {
<span class="FoldColumn">  </span><span class="lnr"> 976 </span>               <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr"> 977 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;newcaseid:</span><span class="Identifier">$newcaseid</span><span class="Constant">;currlog:</span><span class="Identifier">$currlog_file</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr"> 978 </span>
<span class="FoldColumn">  </span><span class="lnr"> 979 </span>               <span class="Statement">if</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!alm&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 980 </span>                   sendanemail <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailme</span>
<span class="FoldColumn">  </span><span class="lnr"> 981 </span>               } <span class="Statement">elseif</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!alc&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 982 </span>                   sendanemail  <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr"> 983 </span>               } <span class="Statement">elseif</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!alb&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr"> 984 </span>                   sendanemail <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailme</span> <span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr"> 985 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr"> 986 </span>                   myputs <span class="Constant">&quot;currently only support !alm(me) !alc(case) !alb(both)&quot;</span>
<span class="FoldColumn">  </span><span class="lnr"> 987 </span>               }
<span class="FoldColumn">  </span><span class="lnr"> 988 </span>
<span class="FoldColumn">  </span><span class="lnr"> 989 </span><span class="Comment">               #t.b.d: send curr log to any other emailaddress</span>
<span class="FoldColumn">  </span><span class="lnr"> 990 </span>               <span class="Statement">if</span> <span class="Identifier">$NEWFEATURE</span> {
<span class="FoldColumn">  </span><span class="lnr"> 991 </span>               -echo -re <span class="Constant">&quot;!alt .*@.*</span><span class="Special">\r</span><span class="Constant">&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr"> 992 </span><span class="Comment">                   #if $redosource {source $configfile}</span>
<span class="FoldColumn">  </span><span class="lnr"> 993 </span><span class="Comment">                   #get user input</span>
<span class="FoldColumn">  </span><span class="lnr"> 994 </span>                   <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr"> 995 </span><span class="Comment">                   #scan the input and find what followed &quot;!v &quot; and use it as newcaseid</span>
<span class="FoldColumn">  </span><span class="lnr"> 996 </span>                   <span class="Statement">set</span> tclcmd [<span class="Statement">string</span> range <span class="Identifier">$a</span> <span class="Constant">4</span> end]
<span class="FoldColumn">  </span><span class="lnr"> 997 </span><span class="Comment">                   #if {[string compare $tclcmd &quot;&quot;] eq 0}</span>
<span class="FoldColumn">  </span><span class="lnr"> 998 </span>                   <span class="Statement">if</span> {[<span class="Statement">string</span> match {*[a-zA-Z]*} <span class="Identifier">$tclcmd</span>]} {
<span class="FoldColumn">  </span><span class="lnr"> 999 </span>                      <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">get tclcmd </span><span class="Identifier">$tclcmd</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1000 </span>                      <span class="Statement">if</span> {[<span class="Statement">catch</span> {<span class="Statement">eval</span> <span class="Identifier">$tclcmd</span>} msg]} {
<span class="FoldColumn">  </span><span class="lnr">1001 </span>                          myputs <span class="Constant">&quot;wrong syntax with the inputed command!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1002 </span>                          myputs <span class="Constant">&quot;the error is:</span><span class="Identifier">$::errorInfo</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1003 </span>                      }
<span class="FoldColumn">  </span><span class="lnr">1004 </span>
<span class="FoldColumn">  </span><span class="lnr">1005 </span>                      <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;caseid is now </span><span class="Identifier">$caseid</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1006 </span><span class="Comment">                      #replace caseid in the caselog_file full name and get new caselogfile name</span>
<span class="FoldColumn">  </span><span class="lnr">1007 </span>                   } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1008 </span>                      myputs <span class="Constant">&quot;nothing found in inputted string&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1009 </span>                   }
<span class="FoldColumn">  </span><span class="lnr">1010 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1011 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1012 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1013 </span>               myputs <span class="Constant">&quot;log has not been started yet, nothing to send!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1014 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1015 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1016 </span>
<span class="FoldColumn">  </span><span class="lnr">1017 </span><span class="Comment">        #log(decoded dump file) attach</span>
<span class="FoldColumn">  </span><span class="lnr">1018 </span>        -echo -re <span class="Constant">&quot;!ad.&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1019 </span><span class="Comment">            #get new caselog_file name from config(which is based on caseid)</span>
<span class="FoldColumn">  </span><span class="lnr">1020 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1021 </span><span class="Comment">            #update the caseid,if ever changed (via !L)</span>
<span class="FoldColumn">  </span><span class="lnr">1022 </span>            <span class="Statement">set</span> caseid <span class="Identifier">$newcaseid</span>
<span class="FoldColumn">  </span><span class="lnr">1023 </span>
<span class="FoldColumn">  </span><span class="lnr">1024 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1025 </span>            <span class="Statement">if</span> {<span class="Identifier">$a</span> eq <span class="Constant">&quot;!adm&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1026 </span>               sendanemail <span class="Identifier">$newcaseid</span> <span class="Constant">&quot;</span><span class="Identifier">$dmp_upload_dir1</span><span class="Constant">*decode*&quot;</span> <span class="Identifier">$emailme</span>
<span class="FoldColumn">  </span><span class="lnr">1027 </span>            } <span class="Statement">elseif</span> {<span class="Identifier">$a</span> eq <span class="Constant">&quot;!adc&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1028 </span>               sendanemail <span class="Identifier">$newcaseid</span> <span class="Constant">&quot;</span><span class="Identifier">$dmp_upload_dir1</span><span class="Constant">*decode*&quot;</span> <span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr">1029 </span>            } <span class="Statement">elseif</span> {<span class="Identifier">$a</span> eq <span class="Constant">&quot;!adb&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1030 </span>               sendanemail <span class="Identifier">$newcaseid</span> <span class="Constant">&quot;</span><span class="Identifier">$dmp_upload_dir1</span><span class="Constant">*decode*&quot;</span> <span class="Identifier">$emailme</span> <span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr">1031 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1032 </span>               myputs <span class="Constant">&quot;currently only support !adm(me) !adc(case) !adb(both)&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1033 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1034 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1035 </span>
<span class="FoldColumn">  </span><span class="lnr">1036 </span>        -echo <span class="Constant">&quot;!q&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1037 </span>            myputs <span class="Constant">&quot; uit interact mode&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1038 </span>            <span class="Statement">return</span>
<span class="FoldColumn">  </span><span class="lnr">1039 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1040 </span>
<span class="FoldColumn">  </span><span class="lnr">1041 </span>
<span class="FoldColumn">  </span><span class="lnr">1042 </span><span class="Comment">        #dumpfile define</span>
<span class="FoldColumn">  </span><span class="lnr">1043 </span>        -echo -re <span class="Constant">&quot;!dd .*</span><span class="Special">\r</span><span class="Constant">&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1044 </span><span class="Comment">            #if $redosource {source $configfile}</span>
<span class="FoldColumn">  </span><span class="lnr">1045 </span><span class="Comment">            #get user input</span>
<span class="FoldColumn">  </span><span class="lnr">1046 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1047 </span><span class="Comment">            #scan the input and find what followed &quot;!d &quot; and use it as newcaseid</span>
<span class="FoldColumn">  </span><span class="lnr">1048 </span>            <span class="Statement">if</span> {[<span class="Statement">scan</span> <span class="Identifier">$a</span> <span class="Constant">&quot;!dd %s&quot;</span> newdmpfilebasename] eq <span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1049 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">get newdmpfilebasename </span><span class="Identifier">$newdmpfilebasename</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1050 </span>
<span class="FoldColumn">  </span><span class="lnr">1051 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1052 </span>               myputs <span class="Constant">&quot;nothing found in inputted string&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1053 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1054 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1055 </span>
<span class="FoldColumn">  </span><span class="lnr">1056 </span><span class="Comment">        #define arbitrary things (using tcl systax)</span>
<span class="FoldColumn">  </span><span class="lnr">1057 </span>        -echo -re <span class="Constant">&quot;!da set.*</span><span class="Special">\r</span><span class="Constant">&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1058 </span><span class="Comment">            #if $redosource {source $configfile}</span>
<span class="FoldColumn">  </span><span class="lnr">1059 </span><span class="Comment">            #get user input</span>
<span class="FoldColumn">  </span><span class="lnr">1060 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1061 </span><span class="Comment">            #scan the input and find what followed &quot;!v &quot; and use it as newcaseid</span>
<span class="FoldColumn">  </span><span class="lnr">1062 </span>            <span class="Statement">set</span> tclcmd [<span class="Statement">string</span> range <span class="Identifier">$a</span> <span class="Constant">4</span> end]
<span class="FoldColumn">  </span><span class="lnr">1063 </span><span class="Comment">            #if {[string compare $tclcmd &quot;&quot;] eq 0}</span>
<span class="FoldColumn">  </span><span class="lnr">1064 </span>            <span class="Statement">if</span> {[<span class="Statement">string</span> match {*[a-zA-Z]*} <span class="Identifier">$tclcmd</span>]} {
<span class="FoldColumn">  </span><span class="lnr">1065 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">get tclcmd </span><span class="Identifier">$tclcmd</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1066 </span>               <span class="Statement">if</span> {[<span class="Statement">catch</span> {<span class="Statement">eval</span> <span class="Identifier">$tclcmd</span>} msg]} {
<span class="FoldColumn">  </span><span class="lnr">1067 </span>                   myputs <span class="Constant">&quot;wrong syntax with the inputed command!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1068 </span>                   myputs <span class="Constant">&quot;the error is:</span><span class="Identifier">$::errorInfo</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1069 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1070 </span>
<span class="FoldColumn">  </span><span class="lnr">1071 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;caseid is now </span><span class="Identifier">$caseid</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1072 </span><span class="Comment">               #replace caseid in the caselog_file full name and get new caselogfile name</span>
<span class="FoldColumn">  </span><span class="lnr">1073 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1074 </span>               myputs <span class="Constant">&quot;nothing found in inputted string&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1075 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1076 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1077 </span>
<span class="FoldColumn">  </span><span class="lnr">1078 </span>
<span class="FoldColumn">  </span><span class="lnr">1079 </span><span class="Comment">        #log with arbitrary name, and...</span>
<span class="FoldColumn">  </span><span class="lnr">1080 </span><span class="Comment">        #clean the log (remove escape, backspace, etc) doesn't work well yet</span>
<span class="FoldColumn">  </span><span class="lnr">1081 </span>        -echo -re <span class="Constant">&quot;!la .*</span><span class="Special">\r</span><span class="Constant">|!lA .*</span><span class="Special">\r</span><span class="Constant">&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1082 </span><span class="Comment">            #if $redosource {source $configfile}</span>
<span class="FoldColumn">  </span><span class="lnr">1083 </span><span class="Comment">            #get user input</span>
<span class="FoldColumn">  </span><span class="lnr">1084 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1085 </span>            <span class="Statement">set</span> newlogbasename <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1086 </span>            <span class="Statement">set</span> cmd_pref <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1087 </span><span class="Comment">            #extract cmd string,a blank,everything until (but excluding the end ^M--don't know why)</span>
<span class="FoldColumn">  </span><span class="lnr">1088 </span>            <span class="Statement">if</span> {[<span class="Statement">regexp</span> {^(!l.) (.*).} <span class="Identifier">$a</span> -&gt; cmd_pref newlogbasename] eq <span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1089 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {
<span class="FoldColumn">  </span><span class="lnr">1090 </span>                   myputs <span class="Constant">&quot;get new logfile:</span><span class="Identifier">$newlogbasename</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1091 </span>                   myputs <span class="Constant">&quot;initcaseid:</span><span class="Identifier">$initcaseid</span><span class="Constant">,initcaselog_file:</span><span class="Identifier">$initcaselog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1092 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1093 </span>               <span class="Statement">if</span> {<span class="Identifier">$cmd_pref</span> == <span class="Constant">&quot;!la&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1094 </span><span class="Comment">                   #in initial caselog_file full name, replace caseid part with the newly </span>
<span class="FoldColumn">  </span><span class="lnr">1095 </span><span class="Comment">                   #acquired newlogbasename and get new caselogfile full name</span>
<span class="FoldColumn">  </span><span class="lnr">1096 </span>                   <span class="Statement">set</span> newcaselog_file [<span class="Statement">string</span> map [<span class="Statement">list</span> <span class="Identifier">$initcaseid</span> <span class="Identifier">$newlogbasename</span>] <span class="Identifier">$initcaselog_file</span>]
<span class="FoldColumn">  </span><span class="lnr">1097 </span>               } <span class="Statement">elseif</span> {<span class="Identifier">$cmd_pref</span> == <span class="Constant">&quot;!lA&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1098 </span>                   <span class="Statement">set</span> newcaselog_file <span class="Identifier">$newlogbasename</span>
<span class="FoldColumn">  </span><span class="lnr">1099 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1100 </span>                   myputs <span class="Constant">&quot;currently only !la and !lA are supported!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1101 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1102 </span>
<span class="FoldColumn">  </span><span class="lnr">1103 </span><span class="Comment">               #now change log to newcaselog_file</span>
<span class="FoldColumn">  </span><span class="lnr">1104 </span>               log_file
<span class="FoldColumn">  </span><span class="lnr">1105 </span>               <span class="Statement">if</span> {[mylog_file <span class="Identifier">$newcaselog_file</span>] == <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr">1106 </span>                   myputs <span class="Constant">&quot;stop logging on:</span><span class="Identifier">$currlog_file</span><span class="Constant">,continue on:</span><span class="Identifier">$newcaselog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1107 </span>                   <span class="Statement">set</span> currlog_file <span class="Identifier">$newcaselog_file</span>
<span class="FoldColumn">  </span><span class="lnr">1108 </span>                   <span class="Statement">set</span> log_started <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1109 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1110 </span>                   myputs <span class="Constant">&quot;command failed,restore old logs&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1111 </span>                   log_file <span class="Identifier">$currlog_file</span>
<span class="FoldColumn">  </span><span class="lnr">1112 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1113 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1114 </span>               myputs <span class="Constant">&quot;nothing found in inputted string&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1115 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1116 </span>
<span class="FoldColumn">  </span><span class="lnr">1117 </span>            <span class="Statement">if</span> <span class="Identifier">$NEWFEATURE</span> {
<span class="FoldColumn">  </span><span class="lnr">1118 </span>            <span class="Statement">incr</span> n
<span class="FoldColumn">  </span><span class="lnr">1119 </span>            <span class="Statement">if</span> {                                                 <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1120 </span>               [<span class="Statement">catch</span>                                             <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1121 </span>                   {<span class="Statement">exec</span>                                        <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1122 </span>                      screen -X scrollback [<span class="Statement">exec</span> wc -l [<span class="Statement">glob</span> <span class="Identifier">$currlog_file</span>]];         <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1123 </span>                   }                                              <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1124 </span>                   msg                                            <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1125 </span>               ]                                               <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1126 </span>               } {
<span class="FoldColumn">  </span><span class="lnr">1127 </span>               myputs <span class="Constant">&quot;Something seems to have gone wrong:&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1128 </span>               myputs <span class="Constant">&quot;Information about it: </span><span class="Identifier">$::errorInfo</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1129 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1130 </span>
<span class="FoldColumn">  </span><span class="lnr">1131 </span>            <span class="Statement">if</span> {                                                 <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1132 </span>               [<span class="Statement">catch</span>                                             <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1133 </span>                   {<span class="Statement">exec</span>                                        <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1134 </span>                      cat [<span class="Statement">glob</span> <span class="Identifier">$currlog_file</span>];                    <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1135 </span>                   }                                              <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1136 </span>                   msg                                            <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1137 </span>               ]                                               <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1138 </span>               } {
<span class="FoldColumn">  </span><span class="lnr">1139 </span>               myputs <span class="Constant">&quot;Something seems to have gone wrong:&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1140 </span>               myputs <span class="Constant">&quot;Information about it: </span><span class="Identifier">$::errorInfo</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1141 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1142 </span>            <span class="Statement">if</span> {                                                 <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1143 </span>               [<span class="Statement">catch</span>                                             <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1144 </span>                   {<span class="Statement">exec</span>                                        <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1145 </span>                      screen -X hardcopy -h [<span class="Statement">glob</span> <span class="Identifier">$currlog_file</span>]-clean<span class="Identifier">$n</span>.log <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1146 </span>                   }                                              <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1147 </span>                   msg                                            <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1148 </span>               ]                                               <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1149 </span>               } {
<span class="FoldColumn">  </span><span class="lnr">1150 </span>               myputs <span class="Constant">&quot;Something seems to have gone wrong:&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1151 </span>               myputs <span class="Constant">&quot;Information about it: </span><span class="Identifier">$::errorInfo</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1152 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1153 </span>            myputs <span class="Constant">&quot;log file </span><span class="Identifier">$currlog_file</span><span class="Constant"> is now cleaned as </span><span class="Identifier">$currlog_file</span><span class="Constant">-clean</span><span class="Identifier">$n</span><span class="Constant">.log&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1154 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1155 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1156 </span>
<span class="FoldColumn">  </span><span class="lnr">1157 </span><span class="Comment">        #execute precmds</span>
<span class="FoldColumn">  </span><span class="lnr">1158 </span>        -echo -re <span class="Constant">&quot;!doprecmds|!ep&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1159 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1160 </span>            do_cmds <span class="Identifier">$pattern4cmd</span> precmds <span class="Identifier">$cmds_intv</span> <span class="Identifier">$cmd_timeout</span>
<span class="FoldColumn">  </span><span class="lnr">1161 </span>            <span class="Statement">unset</span> precmds
<span class="FoldColumn">  </span><span class="lnr">1162 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1163 </span>
<span class="FoldColumn">  </span><span class="lnr">1164 </span><span class="Comment">        #execute cmds</span>
<span class="FoldColumn">  </span><span class="lnr">1165 </span>        -echo -re <span class="Constant">&quot;!docmds|!ec&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1166 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;resourcing config file </span><span class="Identifier">$configfile</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1167 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1168 </span>            do_cmds <span class="Identifier">$pattern4cmd</span> cmds <span class="Identifier">$cmds_intv</span> <span class="Identifier">$cmd_timeout</span>
<span class="FoldColumn">  </span><span class="lnr">1169 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;commands finished&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1170 </span><span class="Comment">            #clear the array after done, give next execution a fresh start</span>
<span class="FoldColumn">  </span><span class="lnr">1171 </span><span class="Comment">            #this is useful when you want to remove a command out of cmds</span>
<span class="FoldColumn">  </span><span class="lnr">1172 </span>            <span class="Statement">unset</span> cmds
<span class="FoldColumn">  </span><span class="lnr">1173 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1174 </span>
<span class="FoldColumn">  </span><span class="lnr">1175 </span><span class="Comment">        #same as !ec but send emails</span>
<span class="FoldColumn">  </span><span class="lnr">1176 </span>        -echo -re <span class="Constant">&quot;!eC.&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1177 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1178 </span>            <span class="Statement">if</span> { (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eCm&quot;</span>) || (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eCc&quot;</span>) || (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eCb&quot;</span>)     <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1179 </span>               } {
<span class="FoldColumn">  </span><span class="lnr">1180 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;resourcing config file </span><span class="Identifier">$configfile</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1181 </span>               <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1182 </span>               do_cmds <span class="Identifier">$pattern4cmd</span> cmds <span class="Identifier">$cmds_intv</span> <span class="Identifier">$cmd_timeout</span>
<span class="FoldColumn">  </span><span class="lnr">1183 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;commands finished,destruct cmds&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1184 </span>               <span class="Statement">unset</span> cmds
<span class="FoldColumn">  </span><span class="lnr">1185 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1186 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1187 </span>
<span class="FoldColumn">  </span><span class="lnr">1188 </span><span class="Comment">            #send email</span>
<span class="FoldColumn">  </span><span class="lnr">1189 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1190 </span>            <span class="Statement">if</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!eCm&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr">1191 </span>               sendanemail <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailme</span>
<span class="FoldColumn">  </span><span class="lnr">1192 </span>            } <span class="Statement">elseif</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!eCc&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr">1193 </span>               sendanemail  <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr">1194 </span>            } <span class="Statement">elseif</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!eCb&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr">1195 </span>               sendanemail <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailme</span> <span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr">1196 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1197 </span>               myputs <span class="Constant">&quot;currently only support !eCm(me) !eCc(case) !eCb(both)&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1198 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1199 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1200 </span>
<span class="FoldColumn">  </span><span class="lnr">1201 </span><span class="Comment">        #repeat cmds</span>
<span class="FoldColumn">  </span><span class="lnr">1202 </span>        -echo -re <span class="Constant">&quot;!repcmds|!rc&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1203 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1204 </span>            repeat_cmds <span class="Identifier">$maxrounds</span> <span class="Identifier">$pattern4cmd</span> cmds <span class="Identifier">$cmds_intv</span> <span class="Identifier">$cmd_timeout</span>
<span class="FoldColumn">  </span><span class="lnr">1205 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1206 </span>
<span class="FoldColumn">  </span><span class="lnr">1207 </span><span class="Comment">        #execute cmds groups</span>
<span class="FoldColumn">  </span><span class="lnr">1208 </span>        -echo -re <span class="Constant">&quot;!docmdsgrps|!eg&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1209 </span>            myputs <span class="Constant">&quot;start cmds groups&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1210 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1211 </span>            do_cmds_groups <span class="Identifier">$pattern4cmd</span> <span class="Identifier">$CGS</span> <span class="Identifier">$cmds_groups_intv</span> <span class="Identifier">$cmds_intv</span> <span class="Identifier">$cmd_timeout</span>
<span class="FoldColumn">  </span><span class="lnr">1212 </span><span class="Comment">            #send email</span>
<span class="FoldColumn">  </span><span class="lnr">1213 </span>            sendanemail <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailme</span>
<span class="FoldColumn">  </span><span class="lnr">1214 </span>
<span class="FoldColumn">  </span><span class="lnr">1215 </span><span class="Comment">            #foreach cmds_group $CGS {</span>
<span class="FoldColumn">  </span><span class="lnr">1216 </span><span class="Comment">        #       unset $cmds_group</span>
<span class="FoldColumn">  </span><span class="lnr">1217 </span><span class="Comment">        #    }</span>
<span class="FoldColumn">  </span><span class="lnr">1218 </span>            <span class="Statement">unset</span> CGS
<span class="FoldColumn">  </span><span class="lnr">1219 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1220 </span>
<span class="FoldColumn">  </span><span class="lnr">1221 </span><span class="Comment">        #repeat cmds groups</span>
<span class="FoldColumn">  </span><span class="lnr">1222 </span>        -echo -re <span class="Constant">&quot;!rg&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1223 </span>            myputs <span class="Constant">&quot;repeat cmds groups&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1224 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1225 </span>            repeat_cmds_groups <span class="Identifier">$maxrounds</span> <span class="Identifier">$pattern4cmd</span> <span class="Identifier">$CGS</span> <span class="Identifier">$round_intv</span> <span class="Identifier">$cmds_groups_intv</span> <span class="Identifier">$cmds_intv</span> <span class="Identifier">$cmd_timeout</span>
<span class="FoldColumn">  </span><span class="lnr">1226 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1227 </span>
<span class="FoldColumn">  </span><span class="lnr">1228 </span><span class="Comment">        #execute pattern-action pairs and optionally send email</span>
<span class="FoldColumn">  </span><span class="lnr">1229 </span>        -echo -re <span class="Constant">&quot;!dopa|!ea|!eA.&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1230 </span>            <span class="Statement">if</span> {<span class="Identifier">$host</span> eq <span class="Constant">&quot;SHELL&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1231 </span>               myputs <span class="Constant">&quot;host is </span><span class="Identifier">$host</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1232 </span>               myputs <span class="Constant">&quot;warning: dump analysis requirs special filename other than the currlog_file:</span><span class="Identifier">$currlog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1233 </span>               myputs <span class="Constant">&quot; so better use !ed !eDx to do dump analysis under local shell&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1234 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1235 </span>
<span class="FoldColumn">  </span><span class="lnr">1236 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1237 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1238 </span><span class="Comment">            #it looks:</span>
<span class="FoldColumn">  </span><span class="lnr">1239 </span><span class="Comment">            #1) string compare can be as simple as $a eq &quot;a&quot;, string compare is also ok</span>
<span class="FoldColumn">  </span><span class="lnr">1240 </span><span class="Comment">            #2) || looks doesn't work with '\'</span>
<span class="FoldColumn">  </span><span class="lnr">1241 </span>            <span class="Statement">if</span> { (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!ea&quot;</span>) || (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eAm&quot;</span>) || (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eAc&quot;</span>) || (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eAb&quot;</span>)    <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1242 </span>               } {
<span class="FoldColumn">  </span><span class="lnr">1243 </span>               do_patterns_actions <span class="Identifier">$host</span> <span class="Identifier">$pattern_action_timeout</span> pattern_action_list <span class="Identifier">$pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1244 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1245 </span>               myputs <span class="Constant">&quot;invalid cmd </span><span class="Identifier">$a</span><span class="Constant">,currently only support !eAm(me) !eAc(case) !eAb(both)&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1246 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1247 </span>
<span class="FoldColumn">  </span><span class="lnr">1248 </span><span class="Comment">            #also send emails with these cmds</span>
<span class="FoldColumn">  </span><span class="lnr">1249 </span>            <span class="Statement">if</span> { (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eAm&quot;</span>) || (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eAc&quot;</span>) || (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eAb&quot;</span>)         <span class="WarningMsg">\</span>
<span class="FoldColumn">  </span><span class="lnr">1250 </span>               } {
<span class="FoldColumn">  </span><span class="lnr">1251 </span>
<span class="FoldColumn">  </span><span class="lnr">1252 </span>               <span class="Statement">if</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!eAm&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr">1253 </span>                   sendanemail <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailme</span>
<span class="FoldColumn">  </span><span class="lnr">1254 </span>               } <span class="Statement">elseif</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!eAc&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr">1255 </span>                   sendanemail <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr">1256 </span>               } <span class="Statement">elseif</span> {[<span class="Statement">string</span> compare <span class="Identifier">$a</span> <span class="Constant">&quot;!eAb&quot;</span>] eq <span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr">1257 </span>                   sendanemail <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailme</span> <span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr">1258 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1259 </span>                   myputs <span class="Constant">&quot;invalid cmd </span><span class="Identifier">$a</span><span class="Constant">,currently only support !eAm(me) !eAc(case) !eAb(both) &quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1260 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1261 </span>
<span class="FoldColumn">  </span><span class="lnr">1262 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1263 </span>
<span class="FoldColumn">  </span><span class="lnr">1264 </span><span class="Comment">            #destruct/fresh the data when done</span>
<span class="FoldColumn">  </span><span class="lnr">1265 </span>            <span class="Statement">unset</span> pattern_action_list
<span class="FoldColumn">  </span><span class="lnr">1266 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1267 </span>
<span class="FoldColumn">  </span><span class="lnr">1268 </span><span class="Comment">        #repeat pattern_action_list for $maxrounds</span>
<span class="FoldColumn">  </span><span class="lnr">1269 </span><span class="Comment">        #or repeat it for given rounds</span>
<span class="FoldColumn">  </span><span class="lnr">1270 </span>        -echo -re {!ra\r|!ra [<span class="Constant">0</span>-<span class="Constant">9</span>]+\r} {
<span class="FoldColumn">  </span><span class="lnr">1271 </span>            <span class="Statement">if</span> {<span class="Identifier">$host</span> eq <span class="Constant">&quot;SHELL&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1272 </span>               myputs <span class="Constant">&quot;host is </span><span class="Identifier">$host</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1273 </span>               myputs <span class="Constant">&quot;warning: better use !ed !eDx to do dump analysis under local shell&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1274 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1275 </span>
<span class="FoldColumn">  </span><span class="lnr">1276 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1277 </span>            <span class="Statement">set</span> rounds <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1278 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1279 </span>
<span class="FoldColumn">  </span><span class="lnr">1280 </span>            <span class="Statement">if</span> { <span class="Identifier">$a</span> eq <span class="Constant">&quot;!ra</span><span class="Special">\r</span><span class="Constant">&quot;</span> } {
<span class="FoldColumn">  </span><span class="lnr">1281 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;round not set, use maxrounds value in config file:</span><span class="Identifier">$maxrounds</span><span class="Constant">}</span>
<span class="FoldColumn">  </span><span class="lnr">1282 </span><span class="Constant">               set rounds </span><span class="Identifier">$maxrounds</span>
<span class="FoldColumn">  </span><span class="lnr">1283 </span><span class="Constant">               repeat_patterns_actions </span><span class="Identifier">$rounds</span><span class="Constant"> </span><span class="Identifier">$host</span><span class="Constant"> </span><span class="Identifier">$pattern_action_timeout</span><span class="Constant"> pattern_action_list </span><span class="Identifier">$pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1284 </span><span class="Constant">            } else {</span>
<span class="FoldColumn">  </span><span class="lnr">1285 </span><span class="Constant">               #scan the input and find what followed &quot;</span>!ra <span class="Constant">&quot; and use it as max_rounds</span>
<span class="FoldColumn">  </span><span class="lnr">1286 </span><span class="Constant">               if {</span>[<span class="Statement">scan</span> <span class="Identifier">$a</span> <span class="Constant">&quot;!ra %d&quot;</span> rounds]<span class="Constant"> eq 1} {</span>
<span class="FoldColumn">  </span><span class="lnr">1287 </span><span class="Constant">                   if </span><span class="Identifier">$DEBUG</span><span class="Constant"> {myputs &quot;</span>round is <span class="Statement">set</span> to <span class="Identifier">$rounds</span>}
<span class="FoldColumn">  </span><span class="lnr">1288 </span>                   repeat_patterns_actions <span class="Identifier">$rounds</span> <span class="Identifier">$host</span> <span class="Identifier">$pattern_action_timeout</span> pattern_action_list <span class="Identifier">$pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1289 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1290 </span>                   myputs <span class="Constant">&quot;rounds of actions are wrong!-</span><span class="Identifier">$rounds</span><span class="Constant">/should be integer-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1291 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1292 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1293 </span>
<span class="FoldColumn">  </span><span class="lnr">1294 </span><span class="Comment">            #destruct/fresh the data when done</span>
<span class="FoldColumn">  </span><span class="lnr">1295 </span>            <span class="Statement">unset</span> pattern_action_list
<span class="FoldColumn">  </span><span class="lnr">1296 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1297 </span>
<span class="FoldColumn">  </span><span class="lnr">1298 </span>        -echo -re {!rG\r|!rG [<span class="Constant">0</span>-<span class="Constant">9</span>]+\r} {
<span class="FoldColumn">  </span><span class="lnr">1299 </span>            <span class="Statement">if</span> {<span class="Identifier">$host</span> eq <span class="Constant">&quot;SHELL&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1300 </span>               myputs <span class="Constant">&quot;host is </span><span class="Identifier">$host</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1301 </span>               myputs <span class="Constant">&quot;warning: better use !ed !eDx to do dump analysis under local shell&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1302 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1303 </span>
<span class="FoldColumn">  </span><span class="lnr">1304 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1305 </span>            <span class="Statement">set</span> rounds <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1306 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1307 </span>
<span class="FoldColumn">  </span><span class="lnr">1308 </span>            <span class="Statement">if</span> { <span class="Identifier">$a</span> eq <span class="Constant">&quot;!rG</span><span class="Special">\r</span><span class="Constant">&quot;</span> } {
<span class="FoldColumn">  </span><span class="lnr">1309 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;round not set, use maxrounds value in config file:</span><span class="Identifier">$maxrounds</span><span class="Constant">}</span>
<span class="FoldColumn">  </span><span class="lnr">1310 </span><span class="Constant">               set rounds </span><span class="Identifier">$maxrounds</span>
<span class="FoldColumn">  </span><span class="lnr">1311 </span><span class="Constant">               repeat_pags </span><span class="Identifier">$rounds</span><span class="Constant"> PAGS </span><span class="Identifier">$host</span><span class="Constant"> </span><span class="Identifier">$pattern_action_timeout</span><span class="Constant"> </span><span class="Identifier">$pattern_action_intv</span><span class="Constant"> </span><span class="Identifier">$pattern_action_groups_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1312 </span><span class="Constant">               sendanemail </span><span class="Identifier">$newcaseid</span><span class="Constant"> </span><span class="Identifier">$currlog_file</span><span class="Constant"> </span><span class="Identifier">$emailme</span><span class="Constant"> </span>
<span class="FoldColumn">  </span><span class="lnr">1313 </span><span class="Constant">            } else {</span>
<span class="FoldColumn">  </span><span class="lnr">1314 </span><span class="Constant">               #scan the input and find what followed &quot;</span>!rG <span class="Constant">&quot; and use it as max_rounds</span>
<span class="FoldColumn">  </span><span class="lnr">1315 </span><span class="Constant">               if {</span>[<span class="Statement">scan</span> <span class="Identifier">$a</span> <span class="Constant">&quot;!rG %d&quot;</span> rounds]<span class="Constant"> eq 1} {</span>
<span class="FoldColumn">  </span><span class="lnr">1316 </span><span class="Constant">                   if </span><span class="Identifier">$DEBUG</span><span class="Constant"> {myputs &quot;</span>round is <span class="Statement">set</span> to <span class="Identifier">$rounds</span>}
<span class="FoldColumn">  </span><span class="lnr">1317 </span>                   repeat_pags <span class="Identifier">$rounds</span> PAGS <span class="Identifier">$host</span> <span class="Identifier">$pattern_action_timeout</span> <span class="Identifier">$pattern_action_intv</span> <span class="Identifier">$pattern_action_groups_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1318 </span>                   sendanemail <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailme</span>
<span class="FoldColumn">  </span><span class="lnr">1319 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1320 </span>                   myputs <span class="Constant">&quot;rounds of actions are wrong!-</span><span class="Identifier">$rounds</span><span class="Constant">/should be integer-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1321 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1322 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1323 </span>
<span class="FoldColumn">  </span><span class="lnr">1324 </span><span class="Comment">            #destruct/fresh the data when done</span>
<span class="FoldColumn">  </span><span class="lnr">1325 </span>            <span class="Statement">unset</span> PAGS
<span class="FoldColumn">  </span><span class="lnr">1326 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1327 </span>
<span class="FoldColumn">  </span><span class="lnr">1328 </span>        -echo <span class="Constant">&quot;!eG&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1329 </span>            <span class="Statement">if</span> {<span class="Identifier">$host</span> eq <span class="Constant">&quot;SHELL&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1330 </span>               myputs <span class="Constant">&quot;host is </span><span class="Identifier">$host</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1331 </span>               myputs <span class="Constant">&quot;warning: better use !ed !eDx to do dump analysis under local shell&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1332 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1333 </span>
<span class="FoldColumn">  </span><span class="lnr">1334 </span>            <span class="Statement">set</span> host1 <span class="Identifier">$host</span>
<span class="FoldColumn">  </span><span class="lnr">1335 </span>            <span class="Statement">set</span> host <span class="Constant">&quot;SHELL&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1336 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1337 </span>            do_pags PAGS <span class="Identifier">$host</span> <span class="Identifier">$pattern_action_timeout</span> <span class="Identifier">$pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1338 </span>            <span class="Statement">set</span> host <span class="Identifier">$host1</span>
<span class="FoldColumn">  </span><span class="lnr">1339 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1340 </span>
<span class="FoldColumn">  </span><span class="lnr">1341 </span>
<span class="FoldColumn">  </span><span class="lnr">1342 </span>        -echo <span class="Constant">&quot;!mlc&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1343 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1344 </span>            myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">currently available command groups:</span><span class="Special">\n</span><span class="Identifier">$CGL</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1345 </span>            <span class="Statement">unset</span> CGL
<span class="FoldColumn">  </span><span class="lnr">1346 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1347 </span>
<span class="FoldColumn">  </span><span class="lnr">1348 </span>        -echo <span class="Constant">&quot;!mlp&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1349 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1350 </span>            myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">currently available pattern action groups for </span><span class="Identifier">$host</span><span class="Constant">:</span><span class="Special">\n</span><span class="Identifier">$PAGL</span><span class="Constant">(</span><span class="Identifier">$host</span><span class="Constant">)</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1351 </span>            <span class="Statement">unset</span> CGL
<span class="FoldColumn">  </span><span class="lnr">1352 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1353 </span>
<span class="FoldColumn">  </span><span class="lnr">1354 </span>        -echo <span class="Constant">&quot;!mls&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1355 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1356 </span>            <span class="Statement">set</span> host1 <span class="Identifier">$host</span>
<span class="FoldColumn">  </span><span class="lnr">1357 </span>            <span class="Statement">set</span> host SHELL
<span class="FoldColumn">  </span><span class="lnr">1358 </span>            myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">currently available pattern action groups for SHELL:</span><span class="Special">\n</span><span class="Identifier">$PAGL</span><span class="Constant">(</span><span class="Identifier">$host</span><span class="Constant">)</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1359 </span>            <span class="Statement">set</span> host <span class="Identifier">$host1</span>
<span class="FoldColumn">  </span><span class="lnr">1360 </span>            <span class="Statement">unset</span> CGL
<span class="FoldColumn">  </span><span class="lnr">1361 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1362 </span>
<span class="FoldColumn">  </span><span class="lnr">1363 </span>        -echo -re <span class="Constant">&quot;!mg .*</span><span class="Special">\r</span><span class="Constant">&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1364 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1365 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1366 </span>            <span class="Statement">set</span> cmd_group <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1367 </span><span class="Comment">            #scan the input and find what followed &quot;!e &quot; and use it as new caseid</span>
<span class="FoldColumn">  </span><span class="lnr">1368 </span>            <span class="Statement">if</span> {[<span class="Statement">scan</span> <span class="Identifier">$a</span> <span class="Constant">&quot;!mg %s&quot;</span> cmd_group] eq <span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1369 </span><span class="Comment">               #eval global $pa_group</span>
<span class="FoldColumn">  </span><span class="lnr">1370 </span>               <span class="Statement">if</span> {[<span class="Statement">lsearch</span> -exact <span class="Identifier">$CGL</span> <span class="Identifier">$cmd_group</span>] == -<span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1371 </span>                   myputs <span class="Constant">&quot;the command group </span><span class="Identifier">$cmd_group</span><span class="Constant"> is not available in CGL!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1372 </span>                   myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">currently available command groups:</span><span class="Special">\n</span><span class="Identifier">$CGL</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1373 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1374 </span>                   do_cmds <span class="Identifier">$pattern4cmd</span> <span class="Identifier">$cmd_group</span> <span class="Identifier">$cmds_intv</span> <span class="Identifier">$cmd_timeout</span>
<span class="FoldColumn">  </span><span class="lnr">1375 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1376 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1377 </span>               myputs <span class="Constant">&quot;nothing found in inputted string&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1378 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1379 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1380 </span>
<span class="FoldColumn">  </span><span class="lnr">1381 </span>
<span class="FoldColumn">  </span><span class="lnr">1382 </span>        -echo -re <span class="Constant">&quot;!mG .*</span><span class="Special">\r</span><span class="Constant">|!mS .*</span><span class="Special">\r</span><span class="Constant">&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1383 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1384 </span>
<span class="FoldColumn">  </span><span class="lnr">1385 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1386 </span>            <span class="Statement">set</span> pa_group <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1387 </span><span class="Comment">            #scan the input and find what followed &quot;!mG &quot; and use it as pa_group</span>
<span class="FoldColumn">  </span><span class="lnr">1388 </span>            <span class="Statement">if</span> {[<span class="Statement">scan</span> <span class="Identifier">$a</span> <span class="Constant">&quot;!mG %s&quot;</span> pa_group] eq <span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1389 </span><span class="Comment">               #eval global $pa_group</span>
<span class="FoldColumn">  </span><span class="lnr">1390 </span>               <span class="Statement">if</span> {[<span class="Statement">lsearch</span> -exact <span class="Identifier">$PAGL</span>(<span class="Identifier">$host</span>) <span class="Identifier">$pa_group</span>] == -<span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1391 </span>                   myputs <span class="Constant">&quot;the pattern action group </span><span class="Identifier">$pa_group</span><span class="Constant"> is not available in PAGL!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1392 </span>                   myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">currently available pattern action groups:</span><span class="Special">\n</span><span class="Identifier">$PAGL</span><span class="Constant">(</span><span class="Identifier">$host</span><span class="Constant">)</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1393 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1394 </span><span class="Comment">                   #do_patterns_actions $host $pattern_action_timeout $pa_group $pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1395 </span>                   do_pags <span class="Identifier">$pa_group</span> <span class="Identifier">$host</span> <span class="Identifier">$pattern_action_timeout</span> <span class="Identifier">$pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1396 </span><span class="Comment">                   #unset $pa_group</span>
<span class="FoldColumn">  </span><span class="lnr">1397 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1398 </span>
<span class="FoldColumn">  </span><span class="lnr">1399 </span>            } <span class="Statement">elseif</span> {[<span class="Statement">scan</span> <span class="Identifier">$a</span> <span class="Constant">&quot;!mS %s&quot;</span> pa_group] eq <span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1400 </span><span class="Comment">               #for !mR, execute what is configured for host &quot;SHELL&quot;, regardless of hostname</span>
<span class="FoldColumn">  </span><span class="lnr">1401 </span><span class="Comment">               #backup curent hostname</span>
<span class="FoldColumn">  </span><span class="lnr">1402 </span>               <span class="Statement">set</span> host1 <span class="Identifier">$host</span>
<span class="FoldColumn">  </span><span class="lnr">1403 </span><span class="Comment">               #treat host as if SHELL</span>
<span class="FoldColumn">  </span><span class="lnr">1404 </span>               <span class="Statement">set</span> host <span class="Constant">&quot;SHELL&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1405 </span><span class="Comment">               #do same as !mG</span>
<span class="FoldColumn">  </span><span class="lnr">1406 </span>               <span class="Statement">if</span> {[<span class="Statement">lsearch</span> -exact <span class="Identifier">$PAGL</span>(<span class="Identifier">$host</span>) <span class="Identifier">$pa_group</span>] == -<span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1407 </span>                   myputs <span class="Constant">&quot;the pattern action group </span><span class="Identifier">$pa_group</span><span class="Constant"> is not available in PAGL!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1408 </span>                   myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">currently available pattern action groups:</span><span class="Special">\n</span><span class="Identifier">$PAGL</span><span class="Constant">(</span><span class="Identifier">$host</span><span class="Constant">)</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1409 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1410 </span><span class="Comment">                   #do_patterns_actions $host $pattern_action_timeout $pa_group $pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1411 </span>                   do_pags <span class="Identifier">$pa_group</span> <span class="Identifier">$host</span> <span class="Identifier">$pattern_action_timeout</span> <span class="Identifier">$pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1412 </span><span class="Comment">                   #unset $pa_group</span>
<span class="FoldColumn">  </span><span class="lnr">1413 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1414 </span>
<span class="FoldColumn">  </span><span class="lnr">1415 </span><span class="Comment">               #send email</span>
<span class="FoldColumn">  </span><span class="lnr">1416 </span>               sendanemail <span class="Identifier">$newcaseid</span> <span class="Identifier">$currlog_file</span> <span class="Identifier">$emailme</span>
<span class="FoldColumn">  </span><span class="lnr">1417 </span>
<span class="FoldColumn">  </span><span class="lnr">1418 </span><span class="Comment">               #when done, recover hostname back </span>
<span class="FoldColumn">  </span><span class="lnr">1419 </span>               <span class="Statement">set</span> host <span class="Identifier">$host1</span>
<span class="FoldColumn">  </span><span class="lnr">1420 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1421 </span>               myputs <span class="Constant">&quot;nothing found in inputted string&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1422 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1423 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1424 </span>
<span class="FoldColumn">  </span><span class="lnr">1425 </span>        -echo <span class="Constant">&quot;!Hl&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1426 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1427 </span>            <span class="Statement">puts</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">host table:</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1428 </span>            <span class="Statement">parray</span> host2name
<span class="FoldColumn">  </span><span class="lnr">1429 </span>            <span class="Statement">puts</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">login info</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1430 </span>            <span class="Statement">parray</span> login_info
<span class="FoldColumn">  </span><span class="lnr">1431 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1432 </span>
<span class="FoldColumn">  </span><span class="lnr">1433 </span>        -echo -re <span class="Constant">&quot;!b.*</span><span class="Special">\\</span><span class="Constant">.&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1434 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1435 </span>
<span class="FoldColumn">  </span><span class="lnr">1436 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1437 </span>            <span class="Statement">set</span> abbkey <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1438 </span><span class="Comment">            #two ways to extract string/CHs: it looks regexp is the best way!</span>
<span class="FoldColumn">  </span><span class="lnr">1439 </span><span class="Comment">            #regexp {c((.*)g)(.*)} &quot;abcdefghi&quot; matched sub1 sub2 sub3</span>
<span class="FoldColumn">  </span><span class="lnr">1440 </span><span class="Comment">            #if {[scan $a &quot;!b%s\.&quot; abbkey] eq 1} </span>
<span class="FoldColumn">  </span><span class="lnr">1441 </span><span class="Comment">            #match string $a with a pattern, all matched part goes to special var &quot;-&gt;&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1442 </span><span class="Comment">            #then extract sub-string from matched part into $abbkey using () and regex</span>
<span class="FoldColumn">  </span><span class="lnr">1443 </span>            <span class="Statement">if</span> {[<span class="Statement">regexp</span> {!b(.*)\.} <span class="Identifier">$a</span> -&gt; abbkey] eq <span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1444 </span><span class="Comment">               #eval global $pa_group</span>
<span class="FoldColumn">  </span><span class="lnr">1445 </span>               <span class="Statement">if</span> {[<span class="Statement">lsearch</span> -exact [<span class="Statement">array</span> names ABB] <span class="Identifier">$abbkey</span>] == -<span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1446 </span>                   myputs <span class="Constant">&quot;abbreviation key:</span><span class="Identifier">$abbkey</span><span class="Constant"> is not configured in ABB, please double check!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1447 </span>                   myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">currently available abbreviation keys are:</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1448 </span>                   <span class="Statement">parray</span> ABB
<span class="FoldColumn">  </span><span class="lnr">1449 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1450 </span>                   send_user <span class="Constant">&quot;=&gt;&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1451 </span>                   send <span class="Constant">&quot;</span><span class="Identifier">$ABB</span><span class="Constant">(</span><span class="Identifier">$abbkey</span><span class="Constant">)&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1452 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1453 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1454 </span>               myputs <span class="Constant">&quot;inputted </span><span class="Identifier">$a</span><span class="Constant"> is a wrong command!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1455 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1456 </span>
<span class="FoldColumn">  </span><span class="lnr">1457 </span>            <span class="Statement">unset</span> ABB
<span class="FoldColumn">  </span><span class="lnr">1458 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1459 </span>
<span class="FoldColumn">  </span><span class="lnr">1460 </span><span class="Comment">        #new shell commands to auto-resolve the name to host</span>
<span class="FoldColumn">  </span><span class="lnr">1461 </span><span class="Comment">        #not finished, it doesn't work, for unknown reason</span>
<span class="FoldColumn">  </span><span class="lnr">1462 </span>        -echo -re <span class="Constant">&quot;!t .*</span><span class="Special">\r</span><span class="Constant">|!s .*</span><span class="Special">\r</span><span class="Constant">&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1463 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1464 </span><span class="Comment">            #scan the input and find what followed &quot;!s &quot; or &quot;!t &quot; and use it as hostname</span>
<span class="FoldColumn">  </span><span class="lnr">1465 </span>            <span class="Statement">if</span> {[<span class="Statement">regexp</span> {^(!.) (.*)} <span class="Identifier">$a</span> -&gt; protocol hostname] eq <span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1466 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get protocol -</span><span class="Identifier">$protocol</span><span class="Constant">- and hostname -</span><span class="Identifier">$hostname</span><span class="Constant">-&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1467 </span>
<span class="FoldColumn">  </span><span class="lnr">1468 </span>               <span class="Statement">if</span> {[<span class="Statement">info</span> exists host2name(<span class="Identifier">$hostname</span>)]} {
<span class="FoldColumn">  </span><span class="lnr">1469 </span>                   <span class="Statement">set</span> host <span class="Identifier">$host2name</span>(<span class="Identifier">$hostname</span>)
<span class="FoldColumn">  </span><span class="lnr">1470 </span>                   <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get resolved for </span><span class="Identifier">$hostname</span><span class="Constant"> to </span><span class="Identifier">$host</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1471 </span>
<span class="FoldColumn">  </span><span class="lnr">1472 </span>                   <span class="Statement">if</span> {<span class="Identifier">$protocol</span> == <span class="Constant">&quot;!t&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1473 </span>                      send <span class="Constant">&quot;</span><span class="Special">\r</span><span class="Constant">telnet </span><span class="Identifier">$host</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1474 </span>                   } <span class="Statement">elseif</span> {<span class="Identifier">$protocol</span> == <span class="Constant">&quot;!s&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1475 </span><span class="Comment">                      #this is not good supported, considering login name ..</span>
<span class="FoldColumn">  </span><span class="lnr">1476 </span>                      send <span class="Constant">&quot;</span><span class="Special">\r</span><span class="Constant">ssh </span><span class="Identifier">$host</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1477 </span>                   } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1478 </span>                      myputs <span class="Constant">&quot;currently only resolve name for telnet/ssh...&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1479 </span>                   }
<span class="FoldColumn">  </span><span class="lnr">1480 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1481 </span>                   myputs <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">hostname not resolved for -</span><span class="Identifier">$hostname</span><span class="Constant">-, please use original telnet/ssh cmds&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1482 </span>                   <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {
<span class="FoldColumn">  </span><span class="lnr">1483 </span>                      <span class="Statement">parray</span> host2name
<span class="FoldColumn">  </span><span class="lnr">1484 </span>                   }
<span class="FoldColumn">  </span><span class="lnr">1485 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1486 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1487 </span>               myputs <span class="Constant">&quot;nothing found in inputted string&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1488 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1489 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1490 </span>
<span class="FoldColumn">  </span><span class="lnr">1491 </span>
<span class="FoldColumn">  </span><span class="lnr">1492 </span><span class="Comment">        #coredump handling, one of the specialized action under local shell mode</span>
<span class="FoldColumn">  </span><span class="lnr">1493 </span>        -echo -re <span class="Constant">&quot;!dodump|!ed|!eD.&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1494 </span>
<span class="FoldColumn">  </span><span class="lnr">1495 </span>            <span class="Statement">if</span> {<span class="Identifier">$host</span> ne <span class="Constant">&quot;SHELL&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1496 </span>               myputs <span class="Constant">&quot;host is </span><span class="Identifier">$host</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1497 </span>               myputs <span class="Constant">&quot;currently only support dump analysis under local shell&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1498 </span>               <span class="Statement">return</span> <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1499 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1500 </span>
<span class="FoldColumn">  </span><span class="lnr">1501 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1502 </span>            <span class="Statement">set</span> a <span class="Identifier">$interact_out</span>(<span class="Constant">0</span>,<span class="Statement">string</span>)
<span class="FoldColumn">  </span><span class="lnr">1503 </span>
<span class="FoldColumn">  </span><span class="lnr">1504 </span><span class="Comment">            #speical handling for coredump analysis</span>
<span class="FoldColumn">  </span><span class="lnr">1505 </span>            <span class="Statement">if</span> {(<span class="Identifier">$a</span> eq <span class="Constant">&quot;!ed&quot;</span>) || (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eDm&quot;</span>) || (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eDc&quot;</span>) || (<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eDb&quot;</span>)} {
<span class="FoldColumn">  </span><span class="lnr">1506 </span>               <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;caseid is now </span><span class="Identifier">$caseid</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1507 </span>               log_file
<span class="FoldColumn">  </span><span class="lnr">1508 </span><span class="Comment">               #log to a seperated,fresh decode file(disable append)</span>
<span class="FoldColumn">  </span><span class="lnr">1509 </span>               log_file -noappend <span class="Identifier">$decodelog_file</span>
<span class="FoldColumn">  </span><span class="lnr">1510 </span>               myputs <span class="Constant">&quot;change log file to </span><span class="Identifier">$decodelog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1511 </span>
<span class="FoldColumn">  </span><span class="lnr">1512 </span><span class="Comment">               #do_patterns_actions $host $pattern_action_timeout pattern_action_list $pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1513 </span>               do_pags core <span class="Identifier">$host</span> <span class="Identifier">$pattern_action_timeout</span> <span class="Identifier">$pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1514 </span>
<span class="FoldColumn">  </span><span class="lnr">1515 </span>               log_file
<span class="FoldColumn">  </span><span class="lnr">1516 </span>               log_file <span class="Identifier">$currlog_file</span>
<span class="FoldColumn">  </span><span class="lnr">1517 </span>               myputs <span class="Constant">&quot;change log file back to </span><span class="Identifier">$currlog_file</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1518 </span>
<span class="FoldColumn">  </span><span class="lnr">1519 </span>               <span class="Statement">if</span> {<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eDm&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1520 </span>                   sendanemail <span class="Identifier">$caseid</span> <span class="Constant">&quot;</span><span class="Identifier">$dmp_upload_dir1</span><span class="Constant">*decode*&quot;</span> <span class="Identifier">$emailme</span>
<span class="FoldColumn">  </span><span class="lnr">1521 </span>               } <span class="Statement">elseif</span> {<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eDc&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1522 </span>                   sendanemail <span class="Identifier">$caseid</span> <span class="Constant">&quot;</span><span class="Identifier">$dmp_upload_dir1</span><span class="Constant">*decode*&quot;</span> <span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr">1523 </span>               } <span class="Statement">elseif</span> {<span class="Identifier">$a</span> eq <span class="Constant">&quot;!eDb&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1524 </span>                   sendanemail <span class="Identifier">$caseid</span> <span class="Constant">&quot;</span><span class="Identifier">$dmp_upload_dir1</span><span class="Constant">*decode*&quot;</span> <span class="Identifier">$emailme</span> <span class="Identifier">$emailcase</span>
<span class="FoldColumn">  </span><span class="lnr">1525 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1526 </span>
<span class="FoldColumn">  </span><span class="lnr">1527 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1528 </span>
<span class="FoldColumn">  </span><span class="lnr">1529 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1530 </span>               myputs <span class="Constant">&quot;invalid cmd </span><span class="Identifier">$a</span><span class="Constant">,currently only support !ed !eDm !eDc !eDb&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1531 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1532 </span>
<span class="FoldColumn">  </span><span class="lnr">1533 </span>            <span class="Statement">unset</span> pattern_action_list
<span class="FoldColumn">  </span><span class="lnr">1534 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1535 </span>
<span class="FoldColumn">  </span><span class="lnr">1536 </span><span class="Comment">        #execute preworks</span>
<span class="FoldColumn">  </span><span class="lnr">1537 </span>        -echo -re <span class="Constant">&quot;!eP&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1538 </span><span class="Comment">            #some pre-work, might be useful for interactions</span>
<span class="FoldColumn">  </span><span class="lnr">1539 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1540 </span>            <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;do some interactions here&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1541 </span>            do_patterns_actions <span class="Identifier">$host</span> <span class="Identifier">$pattern_action_timeout</span> prework <span class="Identifier">$pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1542 </span>            <span class="Statement">unset</span> prework
<span class="FoldColumn">  </span><span class="lnr">1543 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1544 </span>
<span class="FoldColumn">  </span><span class="lnr">1545 </span><span class="Comment">        #execute a block of tcl code</span>
<span class="FoldColumn">  </span><span class="lnr">1546 </span>        -echo -re <span class="Constant">&quot;!eb&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1547 </span>            <span class="Statement">if</span> <span class="Identifier">$redosource</span> {<span class="Statement">source</span> <span class="Identifier">$configfile</span>}
<span class="FoldColumn">  </span><span class="lnr">1548 </span>            myputs <span class="Constant">&quot;going to eval code:-</span><span class="Identifier">$tclblock</span><span class="Constant">-&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1549 </span>            <span class="Statement">set</span> temp [<span class="Statement">eval</span> <span class="Identifier">$tclblock</span>]
<span class="FoldColumn">  </span><span class="lnr">1550 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1551 </span>
<span class="FoldColumn">  </span><span class="lnr">1552 </span>
<span class="FoldColumn">  </span><span class="lnr">1553 </span><span class="Comment">#       -reset &quot;\032&quot; {</span>
<span class="FoldColumn">  </span><span class="lnr">1554 </span><span class="Comment">#           exec kill -STOP 0</span>
<span class="FoldColumn">  </span><span class="lnr">1555 </span><span class="Comment">#       }</span>
<span class="FoldColumn">  </span><span class="lnr">1556 </span>
<span class="FoldColumn">  </span><span class="lnr">1557 </span><span class="Comment">#       -o</span>
<span class="FoldColumn">  </span><span class="lnr">1558 </span><span class="Comment">#       &quot;error&quot; {</span>
<span class="FoldColumn">  </span><span class="lnr">1559 </span><span class="Comment">#           myputs &quot;!some errors were found!want to run diag?(y/n)&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1560 </span><span class="Comment">#           diag_on_error</span>
<span class="FoldColumn">  </span><span class="lnr">1561 </span><span class="Comment">#       }</span>
<span class="FoldColumn">  </span><span class="lnr">1562 </span>
<span class="FoldColumn">  </span><span class="lnr">1563 </span>    }
<span class="FoldColumn">  </span><span class="lnr">1564 </span>}
<span class="FoldColumn">  </span><span class="lnr">1565 </span>
<span class="FoldColumn">  </span><span class="lnr">1566 </span><span class="Comment">##############################main program###################################</span>
<span class="FoldColumn">  </span><span class="lnr">1567 </span><span class="Comment">#include('source' in tcl context) config and lib files</span>
<span class="FoldColumn">  </span><span class="lnr">1568 </span><span class="Comment">#check if file is readable before hand</span>
<span class="FoldColumn">  </span><span class="lnr">1569 </span><span class="Comment">#set files  [ list $configfile $libfile ] </span>
<span class="FoldColumn">  </span><span class="lnr">1570 </span><span class="Statement">set</span> files  [ <span class="Statement">list</span> <span class="Identifier">$configfile</span> ]
<span class="FoldColumn">  </span><span class="lnr">1571 </span>
<span class="FoldColumn">  </span><span class="lnr">1572 </span><span class="Statement">foreach</span> <span class="Statement">file</span> <span class="Identifier">$files</span> {
<span class="FoldColumn">  </span><span class="lnr">1573 </span>    <span class="Statement">if</span> {[<span class="Statement">file</span> readable <span class="Identifier">$file</span>]} {
<span class="FoldColumn">  </span><span class="lnr">1574 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;</span><span class="Special">\[</span>[<span class="Statement">exec</span> date]<span class="Constant">: sourcing file </span><span class="Identifier">$file</span><span class="Special">\]</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1575 </span>        <span class="Statement">source</span> <span class="Identifier">$file</span>
<span class="FoldColumn">  </span><span class="lnr">1576 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1577 </span>        <span class="Statement">puts</span> <span class="Constant">&quot;</span><span class="Special">\[</span>[<span class="Statement">exec</span> date]<span class="Constant">: file </span><span class="Identifier">$file</span><span class="Constant"> doesn't exists</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1578 </span>        <span class="Statement">exit</span> <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1579 </span>    }
<span class="FoldColumn">  </span><span class="lnr">1580 </span>}
<span class="FoldColumn">  </span><span class="lnr">1581 </span><span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;checking log_dir </span><span class="Identifier">$log_dir</span><span class="Constant"> ...</span><span class="Special">\n</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1582 </span><span class="Statement">if</span> {[<span class="Statement">file</span> exists <span class="Identifier">$log_dir</span>]} {
<span class="FoldColumn">  </span><span class="lnr">1583 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {send_user <span class="Constant">&quot;...existing!</span><span class="Special">\n</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1584 </span>} <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1585 </span>    send_user <span class="Constant">&quot;dir </span><span class="Identifier">$log_dir</span><span class="Constant"> didn't exist, creating one...</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1586 </span>    <span class="Statement">if</span> [<span class="Statement">catch</span> {<span class="Statement">file</span> mkdir <span class="Identifier">$log_dir</span>} failed_reason] {
<span class="FoldColumn">  </span><span class="lnr">1587 </span>        send_user <span class="Constant">&quot;failed to creating dir </span><span class="Identifier">$log_dir</span><span class="Constant">: </span><span class="Identifier">$failed_reason</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1588 </span>        <span class="Statement">exit</span> <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1589 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1590 </span>        send_user <span class="Constant">&quot;...done!</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1591 </span>    }
<span class="FoldColumn">  </span><span class="lnr">1592 </span>}
<span class="FoldColumn">  </span><span class="lnr">1593 </span>
<span class="FoldColumn">  </span><span class="lnr">1594 </span><span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;checking log_dir </span><span class="Identifier">$caselog_dir</span><span class="Constant"> ...</span><span class="Special">\n</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1595 </span><span class="Statement">if</span> {[<span class="Statement">file</span> exists <span class="Identifier">$caselog_dir</span>]} {
<span class="FoldColumn">  </span><span class="lnr">1596 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {send_user <span class="Constant">&quot;...existing!</span><span class="Special">\n</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1597 </span>} <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1598 </span>    send_user <span class="Constant">&quot;dir </span><span class="Identifier">$caselog_dir</span><span class="Constant"> didn't exist, creating one...</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1599 </span>    <span class="Statement">if</span> [<span class="Statement">catch</span> {<span class="Statement">file</span> mkdir <span class="Identifier">$caselog_dir</span>} failed_reason] {
<span class="FoldColumn">  </span><span class="lnr">1600 </span>        send_user <span class="Constant">&quot;failed to creating dir </span><span class="Identifier">$caselog_dir</span><span class="Constant">: </span><span class="Identifier">$failed_reason</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1601 </span>        <span class="Statement">exit</span> <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1602 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1603 </span>        send_user <span class="Constant">&quot;...done!</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1604 </span>    }
<span class="FoldColumn">  </span><span class="lnr">1605 </span>}
<span class="FoldColumn">  </span><span class="lnr">1606 </span>
<span class="FoldColumn">  </span><span class="lnr">1607 </span><span class="Statement">set</span> initlog_file <span class="Identifier">$mylog_file</span>
<span class="FoldColumn">  </span><span class="lnr">1608 </span><span class="Comment">#start logging</span>
<span class="FoldColumn">  </span><span class="lnr">1609 </span><span class="Statement">if</span> <span class="Identifier">$log_when_start</span> {
<span class="FoldColumn">  </span><span class="lnr">1610 </span>    log_file <span class="Identifier">$mylog_file</span>
<span class="FoldColumn">  </span><span class="lnr">1611 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;start logging on initial log_file:</span><span class="Identifier">$initlog_file</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1612 </span>} <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1613 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;log_when_start flag not set, log not enabled&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1614 </span>}
<span class="FoldColumn">  </span><span class="lnr">1615 </span>
<span class="FoldColumn">  </span><span class="lnr">1616 </span>
<span class="FoldColumn">  </span><span class="lnr">1617 </span><span class="Statement">if</span> <span class="Identifier">$do_log_user</span> {
<span class="FoldColumn">  </span><span class="lnr">1618 </span>
<span class="FoldColumn">  </span><span class="lnr">1619 </span>} <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1620 </span>    myputs <span class="Constant">&quot;depress the interaction details&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1621 </span>    log_user <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr">1622 </span>}
<span class="FoldColumn">  </span><span class="lnr">1623 </span>
<span class="FoldColumn">  </span><span class="lnr">1624 </span><span class="Comment">#this is not well designed yet</span>
<span class="FoldColumn">  </span><span class="lnr">1625 </span><span class="Statement">set</span> code <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1626 </span>
<span class="FoldColumn">  </span><span class="lnr">1627 </span><span class="Comment">#retrieve logon info from another file,only if not in config file, to the global array</span>
<span class="FoldColumn">  </span><span class="lnr">1628 </span>loaddata <span class="Identifier">$loginfile</span> <span class="Constant">&quot;logininfo&quot;</span> login_info
<span class="FoldColumn">  </span><span class="lnr">1629 </span>
<span class="FoldColumn">  </span><span class="lnr">1630 </span><span class="Comment">#simple paramaters handling,omit params for quick test</span>
<span class="FoldColumn">  </span><span class="lnr">1631 </span><span class="Statement">if</span> {<span class="Identifier">$argc</span>==<span class="Constant">0</span>} {
<span class="FoldColumn">  </span><span class="lnr">1632 </span><span class="Comment">    #to spawn another shell</span>
<span class="FoldColumn">  </span><span class="lnr">1633 </span>    spawn <span class="Identifier">$env</span>(SHELL)
<span class="FoldColumn">  </span><span class="lnr">1634 </span>    <span class="Statement">set</span> code <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr">1635 </span><span class="Comment">    #set hostname to &quot;shell&quot; since no remote host is involved here</span>
<span class="FoldColumn">  </span><span class="lnr">1636 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;no parameter followed, set hostname to 'shell'&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1637 </span>    <span class="Statement">set</span> host SHELL
<span class="FoldColumn">  </span><span class="lnr">1638 </span>
<span class="FoldColumn">  </span><span class="lnr">1639 </span>} <span class="Statement">elseif</span> {<span class="Identifier">$argc</span>==<span class="Constant">1</span>} {
<span class="FoldColumn">  </span><span class="lnr">1640 </span>    usage
<span class="FoldColumn">  </span><span class="lnr">1641 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;no parameter followed the protocol, set hostname to 'localhost'&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1642 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;this is just for quick test&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1643 </span>    <span class="Statement">set</span> hostname <span class="Constant">&quot;localhost&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1644 </span>    spawn [<span class="Statement">lindex</span> <span class="Identifier">$argv</span> <span class="Constant">0</span>] <span class="Identifier">$hostname</span>
<span class="FoldColumn">  </span><span class="lnr">1645 </span>
<span class="FoldColumn">  </span><span class="lnr">1646 </span>} <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1647 </span><span class="Comment">    #get hostname from command line</span>
<span class="FoldColumn">  </span><span class="lnr">1648 </span>    <span class="Statement">set</span> proto [<span class="Statement">lindex</span> <span class="Identifier">$argv</span> <span class="Constant">0</span>]
<span class="FoldColumn">  </span><span class="lnr">1649 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;detected protocol:</span><span class="Identifier">$proto</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1650 </span>
<span class="FoldColumn">  </span><span class="lnr">1651 </span><span class="Comment">    #for telnet,hostname can be retrieved from 2nd argv</span>
<span class="FoldColumn">  </span><span class="lnr">1652 </span>    <span class="Statement">if</span> {<span class="Identifier">$proto</span>==<span class="Constant">&quot;telnet&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1653 </span>        <span class="Statement">set</span> host [<span class="Statement">lindex</span> <span class="Identifier">$argv</span> <span class="Constant">1</span>]
<span class="FoldColumn">  </span><span class="lnr">1654 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;detected host:</span><span class="Identifier">$host</span><span class="Constant"> in </span><span class="Identifier">$proto</span><span class="Constant"> session&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1655 </span>
<span class="FoldColumn">  </span><span class="lnr">1656 </span>    } <span class="Statement">elseif</span> {<span class="Identifier">$proto</span>==<span class="Constant">&quot;ssh&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1657 </span><span class="Comment">        #for ssh, just get the last param</span>
<span class="FoldColumn">  </span><span class="lnr">1658 </span><span class="Comment">        #this is safe only if host entry has been well configured in .ssh/config</span>
<span class="FoldColumn">  </span><span class="lnr">1659 </span>        <span class="Statement">set</span> lastparam [<span class="Statement">lindex</span> <span class="Identifier">$argv</span> [<span class="Statement">expr</span> <span class="Identifier">$argc</span> - <span class="Constant">1</span>] ]
<span class="FoldColumn">  </span><span class="lnr">1660 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;detected host:</span><span class="Identifier">$lastparam</span><span class="Constant"> in </span><span class="Identifier">$proto</span><span class="Constant"> session&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1661 </span><span class="Comment">        #in theory, need more work here to handle other ssh usage: </span>
<span class="FoldColumn">  </span><span class="lnr">1662 </span><span class="Comment">        # e.g.: ssh ping@host, ssh host -l ping, ...</span>
<span class="FoldColumn">  </span><span class="lnr">1663 </span>        <span class="Statement">set</span> host <span class="Identifier">$lastparam</span>
<span class="FoldColumn">  </span><span class="lnr">1664 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1665 </span>        myputs <span class="Constant">&quot;probably protocols excepts telnet/ssh are not tested at this moment!&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1666 </span>    }
<span class="FoldColumn">  </span><span class="lnr">1667 </span>
<span class="FoldColumn">  </span><span class="lnr">1668 </span><span class="Comment">    #spawn telnet/ssh/ftp/rsync/whatever tools,followed by their native params</span>
<span class="FoldColumn">  </span><span class="lnr">1669 </span><span class="Comment">    #this is one of the way in tcl/expect to support more params</span>
<span class="FoldColumn">  </span><span class="lnr">1670 </span><span class="Comment">    #w/o 'eval' this won't work</span>
<span class="FoldColumn">  </span><span class="lnr">1671 </span>
<span class="FoldColumn">  </span><span class="lnr">1672 </span><span class="Comment">    #name resolving function: check if host can be resolved from config file</span>
<span class="FoldColumn">  </span><span class="lnr">1673 </span><span class="Comment">    #use the resolved info if possible</span>
<span class="FoldColumn">  </span><span class="lnr">1674 </span>    <span class="Statement">if</span> {[<span class="Statement">info</span> exists host2name(<span class="Identifier">$host</span>)]} {
<span class="FoldColumn">  </span><span class="lnr">1675 </span>        <span class="Statement">set</span> hostname <span class="Identifier">$host2name</span>(<span class="Identifier">$host</span>)
<span class="FoldColumn">  </span><span class="lnr">1676 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;get resolved for </span><span class="Identifier">$host</span><span class="Constant"> to </span><span class="Identifier">$hostname</span><span class="Constant">&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1677 </span>        <span class="Statement">eval</span> spawn [<span class="Statement">lrange</span> <span class="Identifier">$argv</span> <span class="Constant">0</span> [<span class="Statement">expr</span> <span class="Identifier">$argc</span>-<span class="Constant">2</span>]] <span class="Identifier">$hostname</span>
<span class="FoldColumn">  </span><span class="lnr">1678 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1679 </span>
<span class="FoldColumn">  </span><span class="lnr">1680 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {
<span class="FoldColumn">  </span><span class="lnr">1681 </span>            <span class="Statement">parray</span> host2name
<span class="FoldColumn">  </span><span class="lnr">1682 </span>            myputs <span class="Constant">&quot;hostname not resolved for </span><span class="Identifier">$host</span><span class="Constant">,use original&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1683 </span>        <span class="Statement">eval</span> spawn [<span class="Statement">lrange</span> <span class="Identifier">$argv</span> <span class="Constant">0</span> end]
<span class="FoldColumn">  </span><span class="lnr">1684 </span>    }
<span class="FoldColumn">  </span><span class="lnr">1685 </span>}
<span class="FoldColumn">  </span><span class="lnr">1686 </span>
<span class="FoldColumn">  </span><span class="lnr">1687 </span><span class="Comment">#use these to prefix all cmd output with a timestamp, not well done yet</span>
<span class="FoldColumn">  </span><span class="lnr">1688 </span><span class="Statement">if</span> <span class="Identifier">$NEWFEATURE</span> {
<span class="FoldColumn">  </span><span class="lnr">1689 </span>expect_background -re <span class="Constant">&quot;</span><span class="Special">\[</span><span class="Constant">^ </span><span class="Special">\]</span><span class="Constant">+</span><span class="Special">\n</span><span class="Constant">&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1690 </span>    send_user <span class="Constant">&quot;following output was caught at </span>[<span class="Statement">exec</span> date]<span class="Special">\n</span><span class="Identifier">$expect_out</span><span class="Constant">(0,string)&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1691 </span>}
<span class="FoldColumn">  </span><span class="lnr">1692 </span>}
<span class="FoldColumn">  </span><span class="lnr">1693 </span>
<span class="FoldColumn">  </span><span class="lnr">1694 </span>
<span class="FoldColumn">  </span><span class="lnr">1695 </span><span class="Comment">#different branches based on where we are</span>
<span class="FoldColumn">  </span><span class="lnr">1696 </span><span class="Statement">if</span> {<span class="Identifier">$code</span>==<span class="Constant">&quot;0&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1697 </span><span class="Comment">    #if spawn a local shell, no need autologin, go interact</span>
<span class="FoldColumn">  </span><span class="lnr">1698 </span>    <span class="Statement">if</span> {<span class="Identifier">$doprework</span>==<span class="Constant">&quot;0&quot;</span>} {
<span class="FoldColumn">  </span><span class="lnr">1699 </span>        do_interact <span class="Constant">0</span>
<span class="FoldColumn">  </span><span class="lnr">1700 </span>    }
<span class="FoldColumn">  </span><span class="lnr">1701 </span>} <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1702 </span><span class="Comment">    #otherwise, check if autologin feature is enabled</span>
<span class="FoldColumn">  </span><span class="lnr">1703 </span><span class="Comment">    #if yes,try autologin</span>
<span class="FoldColumn">  </span><span class="lnr">1704 </span>    <span class="Statement">if</span> <span class="Identifier">$autologin</span> {
<span class="FoldColumn">  </span><span class="lnr">1705 </span>        <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {myputs <span class="Constant">&quot;autologin flag set, try autologin&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1706 </span>        do_patterns_actions <span class="Identifier">$host</span> <span class="Identifier">$login_timeout</span> login_info <span class="Identifier">$pattern_action_intv</span>
<span class="FoldColumn">  </span><span class="lnr">1707 </span>
<span class="FoldColumn">  </span><span class="lnr">1708 </span>
<span class="FoldColumn">  </span><span class="lnr">1709 </span><span class="Comment">        #autologin retry feature, not well done yet</span>
<span class="FoldColumn">  </span><span class="lnr">1710 </span><span class="Comment">        #if spawned process failed, looks the whole script exit</span>
<span class="FoldColumn">  </span><span class="lnr">1711 </span>
<span class="FoldColumn">  </span><span class="lnr">1712 </span>        <span class="Statement">set</span> autologin_fail [myexpect <span class="Constant">&quot;check if login success for the 1st time&quot;</span> <span class="Identifier">$success_login_pattern</span> <span class="Constant">&quot;</span><span class="Special">\r</span><span class="Constant">&quot;</span> <span class="Identifier">$login_timeout</span>]
<span class="FoldColumn">  </span><span class="lnr">1713 </span>
<span class="FoldColumn">  </span><span class="lnr">1714 </span><span class="Comment">        #if autologin failed, check if retry feature is enabled</span>
<span class="FoldColumn">  </span><span class="lnr">1715 </span>        <span class="Statement">if</span> <span class="Identifier">$autologin_fail</span> {
<span class="FoldColumn">  </span><span class="lnr">1716 </span><span class="Comment">            #if yes, do retry</span>
<span class="FoldColumn">  </span><span class="lnr">1717 </span>            <span class="Statement">set</span> login_retry_fail [do_autologin_retry <span class="Identifier">$max_login_retry</span> <span class="Identifier">$success_login_pattern</span> <span class="Identifier">$login_timeout</span> <span class="Identifier">$pattern_action_intv</span>]
<span class="FoldColumn">  </span><span class="lnr">1718 </span>
<span class="FoldColumn">  </span><span class="lnr">1719 </span><span class="Comment">            #if retry also failed, based on ...</span>
<span class="FoldColumn">  </span><span class="lnr">1720 </span><span class="Comment">            #not sure this part of logic is correct or not</span>
<span class="FoldColumn">  </span><span class="lnr">1721 </span>            <span class="Statement">if</span> <span class="Identifier">$login_retry_fail</span> {
<span class="FoldColumn">  </span><span class="lnr">1722 </span><span class="Comment">               #if set, force(no need user confirm) interact mode when login not succeed</span>
<span class="FoldColumn">  </span><span class="lnr">1723 </span>               <span class="Statement">if</span> <span class="Identifier">$interact_force_login_nok</span> {
<span class="FoldColumn">  </span><span class="lnr">1724 </span>                   <span class="Statement">puts</span> <span class="Constant">&quot;interact_force_login_nok set, force to interace mode&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1725 </span>                   do_interact <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1726 </span>               } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1727 </span><span class="Comment">                   #failover to manual retry feature: if auto logon failed, continue to do it manually</span>
<span class="FoldColumn">  </span><span class="lnr">1728 </span><span class="Comment">                   #looks {} is not necessary here for if</span>
<span class="FoldColumn">  </span><span class="lnr">1729 </span>                   myputs <span class="Constant">&quot;auto login failed..</span><span class="Special">\n</span><span class="Constant">..want to retry manually?(y/n)&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1730 </span><span class="Comment">                   #raw mode for a while</span>
<span class="FoldColumn">  </span><span class="lnr">1731 </span>                   stty raw
<span class="FoldColumn">  </span><span class="lnr">1732 </span>                   expect_user {
<span class="FoldColumn">  </span><span class="lnr">1733 </span>                      <span class="Constant">&quot;y&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1734 </span>                             myputs <span class="Constant">&quot;go interact mode on user's request&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1735 </span>                             do_interact <span class="Constant">2</span>
<span class="FoldColumn">  </span><span class="lnr">1736 </span><span class="Comment">                             #stty -raw</span>
<span class="FoldColumn">  </span><span class="lnr">1737 </span>                          }
<span class="FoldColumn">  </span><span class="lnr">1738 </span>                      <span class="Constant">&quot;n&quot;</span> {
<span class="FoldColumn">  </span><span class="lnr">1739 </span>                             myputs <span class="Constant">&quot;..exit on no..</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1740 </span>                             <span class="Statement">exit</span> <span class="Constant">1</span>
<span class="FoldColumn">  </span><span class="lnr">1741 </span>                          }
<span class="FoldColumn">  </span><span class="lnr">1742 </span>                      <span class="Statement">default</span> {
<span class="FoldColumn">  </span><span class="lnr">1743 </span>                             myputs <span class="Constant">&quot;..exit on default..</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1744 </span>                             <span class="Statement">exit</span>
<span class="FoldColumn">  </span><span class="lnr">1745 </span>                      }
<span class="FoldColumn">  </span><span class="lnr">1746 </span>                   }
<span class="FoldColumn">  </span><span class="lnr">1747 </span>
<span class="FoldColumn">  </span><span class="lnr">1748 </span>               }
<span class="FoldColumn">  </span><span class="lnr">1749 </span>            } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1750 </span>               myputs <span class="Constant">&quot;auto login succeed after retry&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1751 </span>            }
<span class="FoldColumn">  </span><span class="lnr">1752 </span>        } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1753 </span>            myputs <span class="Constant">&quot;auto login succeed&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1754 </span>        }
<span class="FoldColumn">  </span><span class="lnr">1755 </span>
<span class="FoldColumn">  </span><span class="lnr">1756 </span>
<span class="FoldColumn">  </span><span class="lnr">1757 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1758 </span><span class="Comment">        #if autologin not enabled, go interact(manual login)</span>
<span class="FoldColumn">  </span><span class="lnr">1759 </span>        myputs <span class="Constant">&quot;autologin not set, go interact&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1760 </span>        do_interact <span class="Constant">5</span>
<span class="FoldColumn">  </span><span class="lnr">1761 </span>    }
<span class="FoldColumn">  </span><span class="lnr">1762 </span>}
<span class="FoldColumn">  </span><span class="lnr">1763 </span>
<span class="FoldColumn">  </span><span class="lnr">1764 </span>loaddata <span class="Identifier">$cmdsfile</span> <span class="Constant">&quot;cmds&quot;</span> cmds
<span class="FoldColumn">  </span><span class="lnr">1765 </span>
<span class="FoldColumn">  </span><span class="lnr">1766 </span><span class="Statement">if</span> <span class="Identifier">$doprework</span> {
<span class="FoldColumn">  </span><span class="lnr">1767 </span>}
<span class="FoldColumn">  </span><span class="lnr">1768 </span>
<span class="FoldColumn">  </span><span class="lnr">1769 </span><span class="Comment">#base on config, go interact or auto mode after success login</span>
<span class="FoldColumn">  </span><span class="lnr">1770 </span><span class="Statement">if</span> <span class="Identifier">$interact_after_login_ok</span> {
<span class="FoldColumn">  </span><span class="lnr">1771 </span><span class="Comment">    #go interact mode on login, if flag set</span>
<span class="FoldColumn">  </span><span class="lnr">1772 </span>    do_interact <span class="Constant">3</span>
<span class="FoldColumn">  </span><span class="lnr">1773 </span>} <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1774 </span><span class="Comment">    #otherwise proceed with automode</span>
<span class="FoldColumn">  </span><span class="lnr">1775 </span><span class="Comment">    #some pre-set commands for every login</span>
<span class="FoldColumn">  </span><span class="lnr">1776 </span><span class="Comment">    #  show clock, term wid/length, etc</span>
<span class="FoldColumn">  </span><span class="lnr">1777 </span>    <span class="Statement">puts</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">some pre-checkings..</span><span class="Special">\n</span><span class="Constant">&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1778 </span>    <span class="Statement">if</span> <span class="Identifier">$DEBUG</span> {<span class="Statement">parray</span> precmds}
<span class="FoldColumn">  </span><span class="lnr">1779 </span><span class="Comment">    #executes all CLIes in precmds@2s interval, each wait 10s for outputs</span>
<span class="FoldColumn">  </span><span class="lnr">1780 </span>    do_cmds <span class="Identifier">$pattern4cmd</span> precmds <span class="Constant">2</span> <span class="Constant">5</span>
<span class="FoldColumn">  </span><span class="lnr">1781 </span>
<span class="FoldColumn">  </span><span class="lnr">1782 </span><span class="Comment">    #executes pre-defined cmds for configured rounds</span>
<span class="FoldColumn">  </span><span class="lnr">1783 </span>    repeat_cmds <span class="Identifier">$maxrounds</span> <span class="Identifier">$pattern4cmd</span> cmds <span class="Identifier">$cmds_intv</span> <span class="Identifier">$cmd_timeout</span>
<span class="FoldColumn">  </span><span class="lnr">1784 </span>
<span class="FoldColumn">  </span><span class="lnr">1785 </span><span class="Comment">    #if all done,handover control to user if configured</span>
<span class="FoldColumn">  </span><span class="lnr">1786 </span>    <span class="Statement">if</span> <span class="Identifier">$interact_after_alldone</span> {
<span class="FoldColumn">  </span><span class="lnr">1787 </span>        do_interact <span class="Constant">4</span>
<span class="FoldColumn">  </span><span class="lnr">1788 </span>    } <span class="Statement">else</span> {
<span class="FoldColumn">  </span><span class="lnr">1789 </span>        <span class="Statement">exit</span>
<span class="FoldColumn">  </span><span class="lnr">1790 </span>    }
<span class="FoldColumn">  </span><span class="lnr">1791 </span>}
<span class="FoldColumn">  </span><span class="lnr">1792 </span>
<span class="FoldColumn">  </span><span class="lnr">1793 </span><span class="Comment">#capture eol from spawn when session exit</span>
<span class="FoldColumn">  </span><span class="lnr">1794 </span><span class="Comment">#this feature doesn't work yet</span>
<span class="FoldColumn">  </span><span class="lnr">1795 </span><span class="Statement">if</span> <span class="Identifier">$NEWFEATURE</span> {
<span class="FoldColumn">  </span><span class="lnr">1796 </span>
<span class="FoldColumn">  </span><span class="lnr">1797 </span>expect {
<span class="FoldColumn">  </span><span class="lnr">1798 </span>    eol         {<span class="Statement">puts</span> <span class="Constant">&quot;eol received and exit&quot;</span>}
<span class="FoldColumn">  </span><span class="lnr">1799 </span>}
<span class="FoldColumn">  </span><span class="lnr">1800 </span>
<span class="FoldColumn">  </span><span class="lnr">1801 </span>}
<span class="FoldColumn">  </span><span class="lnr">1802 </span>
<span class="FoldColumn">  </span><span class="lnr">1803 </span><span class="Comment">#             send &quot;got &lt;$expect_out(buffer)&gt;&quot;</span>
<span class="FoldColumn">  </span><span class="lnr">1804 </span><span class="Comment">#             send &quot;but only &lt;$expect_out(0,string)&gt; was expected&quot;    </span>
<span class="FoldColumn">  </span><span class="lnr">1805 </span>
<span class="FoldColumn">  </span><span class="lnr">1806 </span>
</pre>
</body>
</html>
